# Подготовка среды

\[\[toc]]

## Процедура

- StratoVirt поддерживает только виртуальные машины Linux с архитектурой процессоров x86\_64 или AArch64, которые запускают виртуальную машину с такой же архитектурой.
- Компиляция, развертывание и ввод в действие StratoVirt возможны только на ОС openEuler 20.03 LTS и более поздних версиях.
- StratoVirt может работать без полномочий root.

## Требования к среде

Для работы StratoVirt требуется следующая среда:

- Устройство /dev/vhost-vsock (для реализации MMIO — ввод-вывод с отображением портов в память)
- Инструмент Nmap
- Образ ядра (kernel) и образ корневой файловой системы (rootfs)

## Подготовка устройств и инструментов

- Для работы StratoVirt необходимо реализовать устройство MMIO для ввода-вывода с отображением портов в память. Поэтому перед запуском StratoVirt убедитесь, что устройство `/dev/vhost-vsock` существует.
  
  Проверка существования устройства выполняется следующей командой.
  
  ```
  $ ls /dev/vhost-vsock
  /dev/vhost-vsock
  ```
  
  Если устройство не существует, создайте устройство /dev/vhost-vsock командой:
  
  ```
  $ modprobe vhost_vsock
  ```

- Чтобы использовать команды QMP, установите инструмент nmap. После настройки источника yum выполните следующую команду для установки инструмента nmap:
  
  ```
  # yum install nmap
  ```

## Подготовка образов

### Создание образа ядра

В текущей версии StratoVirt поддерживает только образ ядра РЕ процессоров с архитектурами x86\_64 и AArch64. Образ ядра в формате РЕ создается следующим способом:

1. Выполните следующую команду, чтобы получить исходный код ядра openEuler:
   
   ```
   $ git clone https://gitee.com/openeuler/kernel
   $ cd kernel
   ```

2. Проверьте версию ядра и переключитесь на версию 4.19, выполнив команду:
   
   ```
   $ git checkout kernel-4.19
   ```

3. Настройте и скомпилируйте ядро Linux. Рекомендуется использовать предлагаемый конфигурационный файл ([получить конфигурационный файл](https://gitee.com/openeuler/stratovirt/tree/master/docs/kernel_config)). Скопируйте его в каталог ядра и переименуйте на `.config`. Сконфигурировать ядро можно также, выполнив следующую команду и следуя подсказкам:
   
   ```
   $ make menuconfig
   ```

4. Создайте образ ядра и конвертируйте его в формат, выполнив следующую команду. Конвертированный образ — vmlinux.bin.
   
   ```
   $ make -j vmlinux && objcopy -O binary vmlinux vmlinux.bin
   ```
   
   После завершения компиляции в текущем каталоге создается образ ядра vmlinux.bin.
   
   

## Создание образа корневой файловой системы

Образом корневой файловой системы является образ rootfs. Образ ext4 можно загрузить при запуске StratoVirt с помощью файла init. Для создания образа корневой файловой системы ext4 выполните следующие действия:

1. Подготовьте файл необходимого размера (например, создайте файл размером 10 ГиБ в каталоге /home).
   
   ```
   $ cd /home
   $ dd if=/dev/zero of=./rootfs.ext4 bs=1G count=10
   ```

2. Создайте пустую файловую систему ext4 в этом файле.
   
   ```
   $ mkfs.ext4 ./rootfs.ext4
   ```

3. Смонтируйте образ файла. Создайте каталог /mnt/rootfs и подключите к нему rootfs.ext4 в качестве пользователя с полномочиями root.
   
   ```
   $ mkdir /mnt/rootfs
   $ cd /home
   $ sudo mount ./rootfs.ext4 /mnt/rootfs && cd /mnt/rootfs
   ```

4. Получите новую версию файловой системы alpine-mini для соответствующей архитектуры процессора.
   
   - Если используется архитектура AArch64, выполните следующую команду:
     
     ```
     $ wget http://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/aarch64/alpine-minirootfs-3.12.0-aarch64.tar.gz
     $ tar -zxvf alpine-minirootfs-3.12.0-aarch64.tar.gz
     $ rm alpine-minirootfs-3.12.0-aarch64.tar.gz
     ```
   
   - Для архитектуры x86\_64 выполните команду:
     
     ```
     $ wget http://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/x86_64/alpine-minirootfs-3.12.0-x86_64.tar.gz
     $ tar -zxvf alpine-minirootfs-3.12.0-x86_64.tar.gz
     $ rm alpine-minirootfs-3.12.0-x86_64.tar.gz
     ```

5. Создайте символическую ссылку /sbin/init на файл образа ext4 командой:
   
   ```
   $ rm sbin/init; touch sbin/init && cat > sbin/init <<EOF
   #! /bin/sh
   mount -t devtmpfs dev /dev
   mount -t proc proc /proc
   mount -t sysfs sysfs /sys
   ip link set up dev lo
   
   exec /sbin/getty -n -l /bin/sh 115200 /dev/ttyS0
   poweroff -f
   EOF
   
   sudo chmod +x sbin/init
   ```

6. Удалите образ rootfs.
   
   ```
   $ cd /home; umount /mnt/rootfs
   ```
   
   После этого успешно создается образ корневой файловой системы. Теперь можно использовать файл rootfs.ext4 образа корневой файловой системы ext4, который хранится в каталоге /home.