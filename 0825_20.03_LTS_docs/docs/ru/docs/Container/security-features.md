# Функции безопасности

- [Функции безопасности](#security-features)
  - [Настройка механизма безопасности Seccomp](#seccomp-security-configuration)
    - [Сценарии](#scenarios-9)
    - [Ограничения по использованию](#usage-restrictions-10)
    - [Инструкции по использованию](#usage-guide-11)
  - [Настройка механизма безопасности capability](#capabilities-security-configuration)
    - [Сценарии](#scenarios-12)
    - [Ограничения по использованию](#usage-restrictions-13)
    - [Инструкции по использованию](#usage-guide-14)
  - [Настройка модуля обеспечения безопасности SELinux](#selinux-security-configuration)
    - [Сценарии](#scenarios-15)
    - [Ограничения по использованию](#usage-restrictions-16)
    - [Инструкции по использованию](#usage-guide-17)

## Настройка механизма безопасности Seccomp

### Сценарии

Secure computing mode (seccomp) — простой механизм безопасности песочницы, внедренный в ядро Linux, начиная с версии 2.6.23. В определенных сценариях требуется выполнить привилегированные операции в контейнере без запуска привилегированного контейнера. Для этого требуется получить некоторые разрешения, что реализуется добавлением параметра **--cap-add** в среде выполнения. Однако для экземпляров контейнеров со строгими требованиями к безопасности уровень выдаваемых разрешений может не соответствовать требованиям. Для контроля уровня разрешений применяется ряд методов.

- Пример
  
  В сценарии с обычным контейнером можно использовать флаг **-v**, который сопоставит каталог (включая бинарный файл, который не может выполняться обычными пользователями) на хосте с контейнером.
  
  В контейнере в флаговый бит S добавляется chmod 4777 (разрешение на изменение бинарного файла). Таким образом, на хосте обычный пользователь, который не может запускать бинарные файлы (или пользователь с ограниченными правами), может получить разрешение на запуск бинарного файла (например, разрешение **root**) после добавления параметра во флаговый бит S, чтобы расширить спектр своих разрешений или получить доступ к другим файлам.
  
  Если в этом сценарии должны соблюдаться строгие требования к безопасности, необходимо адаптировать системные вызовы chmod, fchmod и fchmodat, используя механизм seccomp.

### Ограничения по использованию

- Механизм seccomp может влиять на производительность. Перед настройкой seccomp оцените сценарий и добавляйте эти настройки только при необходимости.

### Инструкция по использованию

С помощью **--security-opt** передайте конфигурационный файл в контейнер, в котором необходимо отфильтровать системные вызовы.

```
isula run -itd --security-opt seccomp=/path/to/seccomp/profile.json rnd-dockerhub.huawei.com/official/busybox
```

> ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:
> 
> 1. Когда конфигурационный файл передается в контейнер посредством **--security-opt** во время создания контейнера, используется конфигурационный файл по умолчанию (**/etc/isulad/seccomp\_default.json**).
> 2. Если во время создания контейнера параметру **--security-opt** устанавливается значение **unconfined**, системные вызовы для контейнера не фильтруются.
> 3. Путь **/path/to/seccomp/profile.json** должен быть абсолютным.

#### Получение конфигурации seccomp по умолчанию для обычного контейнера

- Запустите обычный контейнер (или контейнер с разрешением **--cap-add**) и проверьте его настройки разрешений по умолчанию.
  
  ```
  cat /etc/isulad/seccomp_default.json | python -m json.tool > profile.json
  ```
  
  Поле seccomp содержит множество полей **syscall**. Далее используйте только значение полей **syscalls** и выполните настройку, ориентируясь на настройки конфигурационного файла seccomp.
  
  ```
  "defaultAction": "SCMP_ACT_ERRNO",
  "syscalls": [
  {
  "action": "SCMP_ACT_ALLOW",
  "name": "accept"
  },
  {
  "action": "SCMP_ACT_ALLOW",
  "name": "accept4"
  },
  {
  "action": "SCMP_ACT_ALLOW",
  "name": "access"
  },
  {
  "action": "SCMP_ACT_ALLOW",
  "name": "alarm"
  },
  {
  "action": "SCMP_ACT_ALLOW",
  "name": "bind"
  },
  ]...
  ```

- Убедитесь, что конфигурация seccomp распознается службой LXC.
  
  ```
  cat /var/lib/isulad/engines/lcr/74353e38021c29314188e29ba8c1830a4677ffe5c4decda77a1e0853ec8197cd/seccomp
  ```
  
  ```
  ...
  waitpid allow
  write allow
  writev allow
  ptrace allow
  personality allow [0,0,SCMP_CMP_EQ,0]
  personality allow [0,8,SCMP_CMP_EQ,0]
  personality allow [0,131072,SCMP_CMP_EQ,0]
  personality allow [0,131080,SCMP_CMP_EQ,0]
  personality allow [0,4294967295,SCMP_CMP_EQ,0]
  ...
  ```

#### Настройка конфигурационного файла seccomp

При запуске контейнера добавьте конфигурационный файл seccomp с помощью параметра 
**--security-opt**. На основе данного файла экземпляры контейнера ограничивают выполнение системных API. Получите конфигурацию seccomp по умолчанию для обычных контейнеров, получите полный шаблон и настройте конфигурационный файл для запуска контейнера, опираясь на инструкции данного раздела.

```
isula run --rm -it --security-opt seccomp:/path/to/seccomp/profile.json rnd-dockerhub.huawei.com/official/busybox
```

Шаблон конфигурационного файла:

```
{
"defaultAction": "SCMP_ACT_ALLOW",
"syscalls": [
{
"name": "syscall-name",
"action": "SCMP_ACT_ERRNO",
"args": null
}
]
}
```

> ![](./public_sys-resources/icon-notice.gif) **ПРИМЕЧАНИЕ**:
> 
> - **defaultAction** и **syscalls**: выполняемые данными вызовами действия одного типа, но значения параметров разные. Цель настройки заключается в том, чтобы каждый вызов syscall имел действие по умолчанию. Превалируют в массиве syscalll четкие определения. Если значения **defaultAction** и **action** отличаются, конфликтов в действиях не возникнет. Поддерживаются следующие действия:  
**SCMP\_ACT\_ERRNO**: запрещает делать вызовы syscalls и выводит информацию об ошибке.  
**SCMP\_ACT\_ALLOW:** разрешает делать вызовы syscalls.
> - **syscalls:** массив, который может содержать один или несколько вывозов syscalls. **args** необязательная настройка.
> - **name**: syscalls, которые необходимо отфильтровать.
> - **args**: массив. Определение каждого объекта в массиве:
> 
> ```
> type Arg struct {  
> Index    uint     `json:"index"`     // Parameter ID. Take open(fd, buf, len) as an example. The fd corresponds to 0 and buf corresponds to 1.  
> Value    uint64   `json:"value"`     // Value to be compared with the parameter.  
> ValueTwo uint64   `json:"value_two"` // It is valid only when Op is set to MaskEqualTo. After the bitwise AND operation is performed on the user-defined value and the value of Value, the result is compared with the value of ValueTwo. If they are the same, the action is executed.  
> Op       Operator `json:"op"`  
> }  
> ```
> 
> Значением **Op** в **args** может быть любой из ниже перечисленных:  
"SCMP\_CMP\_NE":  NotEqualTo  
"SCMP\_CMP\_LT":  LessThan  
"SCMP\_CMP\_LE":  LessThanOrEqualTo  
"SCMP\_CMP\_EQ":  EqualTo  
"SCMP\_CMP\_GE":  GreaterThanOrEqualTo  
"SCMP\_CMP\_GT":  GreaterThan  
"SCMP\_CMP\_MASKED\_EQ": MaskEqualTo

## Настройка механизма безопасности capability

### Сценарии

Механизм обеспечения безопасности capability внедрен в ядро Linux, начиная с версии 2.2. Чтобы не допустить использования разрешений уровня **root**, усиливается контроль разрешений суперадминистратора. Разрешения уровня **root** делятся по доменам. Таким образом, их можно включать или отключать по отдельности для каждого домена. Для получения подробной информации о механизме capability см. _Linux Programmer's Manual_ ([capabilities(7) - Linux man page](http://man7.org/linux/man-pages/man7/capabilities.7.html)).

```
man capabilities
```

### Ограничения по использованию

- Список разрешений по умолчанию (белый список) службы iSulad, которыми наделяются процессы обычных контейнеров:
  
  ```
  "CAP_CHOWN",
  "CAP_DAC_OVERRIDE",
  "CAP_FSETID",
  "CAP_FOWNER",
  "CAP_MKNOD",
  "CAP_NET_RAW",
  "CAP_SETGID",
  "CAP_SETUID",
  "CAP_SETFCAP",
  "CAP_SETPCAP",
  "CAP_NET_BIND_SERVICE",
  "CAP_SYS_CHROOT",
  "CAP_KILL",
  "CAP_AUDIT_WRITE"
  ```

- Конфигурации по умолчанию: **CAP\_SETUID** и **CAP\_FSETID**. Если хост и контейнер используют один каталог, контейнер может установить разрешения для бинарного файла в таком общем каталоге. Обычные пользователи на хосте могут использовать этот способ для повышения уровня разрешений. Возможность контейнером записи **CAP\_AUDIT\_WRITE** на хост может вызвать риски. Если сценарию приложения такое разрешение не требуется, рекомендуется с помощью **--cap-drop** удалить эту функцию при запуске контейнера.

- Добавлением разрешений расширяется набор возможностей, которыми наделяется процесс контейнера по сравнению с имеющимися ранее. Кроме того, открывается больше API системного вызова.

### Инструкция по использованию

Для добавления конкретных разрешений в контейнер или удаления разрешений в iSulad используются параметры **--cap-add** или **--cap-drop**. Не добавляйте дополнительные разрешения контейнерам без необходимости. Рекомендуется удалить из контейнера разрешения, выделяемые по умолчанию, которые в данный момент не требуются.

```
isula run --rm -it --cap-add all --cap-drop SYS_ADMIN rnd-dockerhub.huawei.com/official/busybox
```

## Настройка модуля обеспечения безопасности SELinux

### Сценарии

Security-Enhanced Linux (SELinux) — это модуль обеспечения безопасности ядра Linux, который предоставляет механизм поддержки политик реализации безопасности методом контроля доступа. Благодаря применяемому методу контроля доступа по категориям (Multi-Category Security; MCS) iSulad маркирует процессы в контейнерах и контролирует, таким образом, доступ контейнеров к ресурсам, снижая риски расширения набора выдаваемых разрешений и предотвращая нанесение системе повреждений, вызванных неправильными действиями.

### Ограничения по использованию

- Убедитесь, что механизм SELinux включен для хоста и демона (поле **selinux-enabled** в файле **/etc/isulad/daemon.json** имеет значение **true**, или в командную строку добавлен параметр 
  **--selinux-enabled**).
- Убедитесь, что на хосте сконфигурирована корректная политика SELinux. Рекомендуется установить политику container-selinux.
- Использование SELinux влияет на производительность. Поэтому оцените данный сценарий, прежде чем настраивать механизм SELinux. Включайте функцию SELinux для демона и настраивайте конфигурацию SELinux в контейнере только по необходимости.
- Настраивая метки для смонтированного тома, не устанавливайте исходный каталог как подкаталог **/**, **/usr**, **/etc**, **/tmp**, **/home**, **/run**, **/var**, **/root** или **/usr**.

> ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:
> 
> - iSulad не поддерживает маркировку файловой системы контейнера. Чтобы файловая система контейнера и каталог конфигурации имели метки с разрешением на доступ для контейнера, выполните команду **chcon**.
> - Если механизм контроля доступа SELinux включен для iSulad, рекомендуется перед запуском демона добавить метку в каталог **/var/lib/isulad**. Файлы и папки, генерируемые в каталоге во время создания контейнера, наследуют данную метку по умолчанию. Пример:
> 
> ```
> chcon -R system_u:object_r:container_file_t:s0 /var/lib/isulad  
> ```

### Инструкция по использованию

- Включите SELinux для демона.
  
  ```
  isulad --selinux-enabled
  ```

  

- Настройте метки контекста безопасности SELinux во время запуска контейнера.
  
  **--security-opt="label=user:USER"**: ввод пользователя меток для контейнера.
  
  **--security-opt="label=role:ROLE"**: установка роли меток для контейнера.
  
  **--security-opt="label=type:TYPE"**: задание типа меток для контейнера.
  
  **--security-opt="label=level:LEVEL"**: установка уровня меток для контейнера.
  
  **--security-opt="label=disable"**: отключение настроек SELinux для контейнера.
  
  ```
  $ isula run -itd --security-opt label=type:container_t --security-opt label=level:s0:c1,c2 rnd-dockerhub.huawei.com/official/centos
  9be82878a67e36c826b67f5c7261c881ff926a352f92998b654bc8e1c6eec370
  ```

  

- Добавьте метку selinux к смонтированному тому (**z** означает общий режим).
  
  ```
  $ isula run -itd -v /test:/test:z rnd-dockerhub.huawei.com/official/centos
  9be82878a67e36c826b67f5c7261c881ff926a352f92998b654bc8e1c6eec370
  
  $ls -Z /test
  system_u:object_r:container_file_t:s0 file
  ```
  
    