# Конфигурирование виртуальной машины

## Обзор

В отличие от Libvirt, который для настройки виртуальных машин использует XML-файлы, программное обеспечение StratoVirt позволяет конфигурировать данные о процессоре, памяти и диске виртуальной машины с помощью параметров командной строки или файла JSON. В данном разделе приведено описание двух методов конфигурирования.

> ![](./figures/en-05.png)
> 
> Если доступны оба метода, рекомендуется отдать предпочтение командной строке.
> 
> В этом документе /path/to/socket — это файл сокета, путь к которому определяет пользователь.

## Спецификации

- Количество процессоров ВМ: \[1254]
- Объем памяти ВМ: \[128 МиБ,512 ГиБ]
- Количество дисков виртуальной машины (включая диски горячей замены): \[0,6]
- Количество сетевых карт NIC ВМ (включая карты NIC для горячей замены): \[0,2]
- Устройство консоли ВМ поддерживает только одностороннее соединение.
- На платформе x86\_64 помимо дисков и карт NIC можно сконфигурировать еще максимум два устройства. На платформе AArch64 помимо дисков и карт NIC можно сконфигурировать еще максимум двенадцать устройств.

## Минимальная конфигурация

Минимальная конфигурация StratoVirt:

- Должен быть файл ядра Linux в формате РЕ.
- Необходимо задать образ корневой файловой системы rootfs в качестве устройства virtio-blk и добавить его к параметрам ядра.
- Для контроля StratoVirt необходимо использовать api-channel.
- Если для входа в систему будет использоваться ttyS0, необходимо добавить в командную строку запуска последовательный порт и добавить ttyS0 к параметрам ядра.

## Конфигурирование с помощью параметров командной строки

**Обзор**

Настройкой параметров командной строки задается конфигурация виртуальной машины.

**Формат команды**

Формат команды, сконфигурированной с помощью команды cmdline:

**$ /path/to/stratovirt** *-\[параметр 1] \[значение параметра]] -\[параметр 2] \[значение параметра] ...*

**Процедура**

1. Чтобы убедиться в возможности создания сокета, необходимого для api-channel, выполните очистку среды следующей командой:
   
   ```
   $rm [parameter] [user-defined socket file path]
   ```

2. Выполните команду cmdline.
   
   ```
   $ /path/to/stratovirt -[Parameter 1] [Parameter Option] -[Parameter 2] [Parameter Option] ...
   ```

**Описание параметров**

В следующей таблице перечислены параметры команды cmdline.

**Табл. 1** Описание параметров команды

| Параметр          | Значение                                                     | Описание                                                     |
| :---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| -name             | *VMName*                                                     | Имя виртуальной машины (строка длиной от 1 до 255 символов). |
| -kernel           | /path/to/vmlinux.bin                                         | Образ ядра.                                                  |
| -append           | console=ttyS0 root=/dev/vda reboot=k panic=1                 | Параметры командной строки ядра.                             |
| -initrd           | /path/to/initrd.img                                          | Файл initrd.                                                 |
| -smp              | \[cpus=] количество процессоров                              | Количество процессоров. Диапазон значений: \[1254].          |
| -m                | Byte/MiB/GiB                                                 | Размер памяти. Диапазон значений: \[128MiB,512GiB].          |
| -drive            | id=rootfs,file=/path/to/rootfs\[,readonly=false,direct=true,serial=serial\_num] | Конфигурация устройства virtio-blk.                          |
| -netdev           | id=iface\_id,netdev=tap0\[,mac=mac\_address]                 | Конфигурация устройства virtio-net.                          |
| -chardev          | id=console\_id,path=/path/to/socket                          | Конфигурация virtio-console. Перед выполнением команды убедитесь, что файл сокета не существует. |
| -device           | vsock,id=vsock\_id,guest-cid=3                               | Конфигурация vhost-vsock.                                    |
| -api-channel      | unix:/path/to/socket                                         | Конфигурация api-channel. Перед выполнением команды убедитесь, что файл сокета не существует. |
| -serial           | stdio                                                        | Конфигурация устройства с последовательным портом.           |
| -D                | /path/to/logfile                                             | Конфигурация файлов журнала.                                 |
| -pidfile          | /path/to/pidfile                                             | Конфигурация файла PID. Этот параметр должен использоваться вместе с параметром -daemonize. |
| -disable-seccomp  | \--                                                          | Отключение функции Seccomp, которая по умолчанию включена.   |
| -omit\_vm\_memory | \--                                                          | Данный параметр отменяет создание дампа памяти ВМ при переходе процесса в состояние сбоя (panic state). |
| -daemonize        | \--                                                          | Включает фоновый процесс демон (daemon).                     |

**Пример**

1. Следующей командой удаляется файл сокета, чтобы убедиться в возможности создания api-channel.
   
   ```
   $ rm -f /tmp/stratovirt.socket
   ```

2. Далее выполняется команда StratoVirt.
   
   ```
   $ /path/to/stratovirt \
       -kernel /path/to/vmlinux.bin \
       -append console=ttyS0 root=/dev/vda rw reboot=k panic=1 \
       -drive file=/home/rootfs.ext4,id=rootfs,readonly=false \
       -api-channel unix:/tmp/stratovirt.socket \
       -serial stdio
   ```
   
   После выполнения команды виртуальная машина создается и запускается в соответствии с заданными параметрами конфигурации.

## Конфигурирование с помощью файла JSON

**Обзор**

В данном способе при запуске StratoVirt для создания виртуальной машины система считывает содержимое указанного файла JSON с конфигурацией виртуальной машины.

**Формат команды**

Для конфигурирования ВМ с помощью файла JSON используется следующий формат команды. В этой команде /path/to/json указывает путь к соответствующему файлу.

**$ /path/to/stratovirt -config** */path/to/json -\[параметр] \[значение параметра]*

**Процедура**

1. Создайте файл JSON и запишите в него конфигурацию виртуальной машины.

2. Выполните команду StratoVirt, чтобы создать виртуальную машину.
   
   ```
   $ /path/to/stratovirt -config /path/to/json - [Parameter] [Parameter Option]
   ```

**Описание параметров**

В следующей таблице приведены параметры конфигурационного файла JSON.

**Табл. 2** Параметры конфигурационного файла

| Параметр| Значение| Описание|
|----------|----------|----------|
| boot-source| "kernel\_image\_path": "/path/to/vmlinux.bin","boot\_args": "console=ttyS0 reboot=k panic=1 pci=off tsc=reliable ipv6.disable=1 root=/dev/vda quiet","initrd\_fs\_path": "/path/to/initrd.img"| Настройка образа и параметров ядра. Параметр `initrd_fs_path` необязателен.|
| machine-config| "name": "abc","vcpu\_count": 4,"mem\_size": 805306368,"omit\_vm\_memory": true| Количество виртуальных процессоров и объем памяти. Параметр `omit_vm_memory` необязателен.|
| drive| "drive\_id": "rootfs","path\_on\_host": "/path/to/rootfs.ext4","read\_only": false,"direct": true,"serial\_num": "xxxxx"| Конфигурация диска virtio-blk. Параметр `serial_num` необязателен.|
| net| "iface\_id": "net0","host\_dev\_name": "tap0","mac": "xx:xx:xx:xx:xx:xx"| Конфигурация NIC-карты virtio-net. Параметр `mac` необязателен.|
| console| "console\_id": "charconsole0","socket\_path": "/path/to/socket"| Конфигурация |последовательного порта virtio-console. Перед настройкой последовательного порта убедитесь, что файл сокета не существует.|
| vsock| "vsock\_id": "vsock0","guest\_cid": 3| Конфигурация устройства virtio-vsock.|
| serial| "stdio": true| Конфигурация устройства с последовательным портом.|

В следующей таблице приведены параметры выполняемых команд в файле JSON.

**Табл. 3** Параметры выполняемых команд в файле JSON

| Параметр| Значение| Описание|
|----------|----------|----------|
| -config| /path/to/json| Конфигурация пути к файлу.|
| -api-channel| unix:/path/to/socket| Конфигурация api-channel. Перед выполнением команды убедитесь, что файл сокета не существует.|
| -D| /path/to/logfile| Конфигурация файлов журнала.|
| -pidfile| /path/to/pidfile| Параметр PID-файла, который должен использоваться вместе с параметром -daemonize. Перед выполнением команды убедитесь, что PID-файл не существует.|
| -disable-seccomp| \--| Отключение функции Seccomp, которая по умолчанию включена.|
| -daemonize| \--| Включает фоновый процесс демон (daemon).|

**Пример**

1. В данном примере создается JSON-файл /home/config.json. Содержимое файла выглядит следующим образом:

```
{
  "boot-source": {
    "kernel_image_path": "/path/to/vmlinux.bin",
    "boot_args": "console=ttyS0 reboot=k panic=1 pci=off tsc=reliable ipv6.disable=1 root=/dev/vda quiet"
  },
  "machine-config": {
    "name": "abc",
    "vcpu_count": 2,
    "mem_size": 268435456,
    "omit_vm_memory": false
  },
  "drive": [
    {
      "drive_id": "rootfs",
      "path_on_host": "/path/to/rootfs.ext4",
      "direct": true,
      "read_only": false,
      "serial_num": "abcd"
    }
  ],
  "net": [
    {
      "iface_id": "net0",
      "host_dev_name": "tap0",
      "mac": "0e:90:df:9f:a8:88"
    }
  ],
  "console": {
    "console_id": "charconsole0",
    "socket_path": "/path/to/console.socket"
  },
  "serial": {
    "stdio": true
  },
  "vsock": {
    "vsock_id": "vsock-123321132",
    "guest_cid": 4
  }
}

```

2. Запустите StratoVirt, чтобы считать файл JSON и затем создать и запустить виртуальную машину.

```
$ /path/to/stratovirt \
    -config /home/config.json \
    -api-channel unix:/tmp/stratovirt.socket
```

Успешный результат выполнения команды означает, что виртуальная машина создана и запущена.