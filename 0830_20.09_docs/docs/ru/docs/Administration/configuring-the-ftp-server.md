# Настройка сервера FTP

\[\[toc]]

## Введение

### Общие понятия о FTP

Протокол File Transfer Protocol (FTP) является одним из первых протоколов передачи файлов в Интернете. Он используется для передачи файлов между сервером и клиентом. С помощью FTP пользователи получают доступ к файлам в удаленной системе, используя набор стандартных команд без входа в эту удаленную систему. Сервер FTP предоставляет следующие функции:

- Классификация абонентов
  
  По умолчанию сервер FTP подразделяет пользователей на реальных, гостевых и анонимных пользователей по их статусу входа в систему. Пользователи каждого типа получают свой набор прав доступа. Реальные пользователи имеют полные права на доступ, анонимные пользователи имеют право только на загрузку.

- Записи команд и файлов журнала
  
  Используя syslogd, FTP ведет записи данных, включая историю команд и информацию о выполненных пользователем передачах (например, время передачи и размер файла). Пользователи могут получить информацию журнала из каталога /var/log/.

- Ограничение области доступа для пользователей
  
  FTP может ограничить пользователю рабочую область доступа домашним каталогом пользователя. После входа пользователя в систему через FTP домашним каталогом пользователя является отображаемый системой корневой каталог. Такая среда называется change root (кратко chroot). Таким образом, пользователи могут получить доступ только к главному каталогу, но не к важным каталогам, таким как /etc, /home и /usr/local. Это защищает систему и обеспечивает ее безопасность.

### Порт, используемый сервером FTP

Службе FTP требуется несколько сетевых портов. Сервер использует следующие порты:

- Command channel. По умолчанию номер порта — **21**.
- Data channel. По умолчанию номер порта — **20**.

Порт 21 используется для получения запросов на соединение от клиента FTP, а порт 20 используется сервером FTP для проактивного подключения к клиенту FTP.

### Понятие vsftpd

В FTP используется незашифрованный режим передачи и длительное хранение истории, поэтому сервер нельзя назвать безопасным. В этом разделе описывается концепция FTP-сервера с поддержкой IPv6 и SSL (Very Secure FTP Daemon; vsftpd), которая позволяет использовать FTP более безопасным способом.

С помощью vsftpd формируется среда безопасной работы сервера FTP. Особенности концепции vsftpd:

- Пользователь, запускающий службу vsftpd, является обычным пользователем, имеющим минимальные права доступа к системе. Кроме того, для изменения корневого каталога служба vsftpd использует chroot, что предотвращает риск неправильного использования системных инструментов.
- Любая команда vsftpd, которая требует прав на выполнение высокого уровня, контролируется специальной программой верхнего уровня. Программа верхнего уровня имеет минимальные права и не влияет на систему.
- В службе vsftpd интегрировано большинство дополнительных команд (например, dir, ls и cd), используемых сервером FTP. Как правило, системе не требуются другие дополнительные команды, что повышает безопасность системы.

## Использование vsftpd

### Установка vsftpd

Чтобы использовать службу vsftpd, необходимо установить программное обеспечение vsftpd. Если источник yum сконфигурирован, установите службу vsftpd, выполнив следующую команду как пользователь:

```
# dnf install vsftpd
```

### Управление службами

Чтобы запустить, остановить или перезапустить службу vsftpd, выполните отведенную для этого команду как пользователь root.

- Запуск службы vsftpd
  
  ```
  # systemctl start vsftpd
  ```
  
  Убедитесь, что порт связи 21 включен, выполнив команду **netstat**. Если появится следующая информация, значит, служба vsftpd включена.
  
  ```
  # netstat -tulnp | grep 21
  tcp6       0      0 :::21                   :::*                    LISTEN      19716/vsftpd
  ```
  
  > ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:  
Если команда **netstat** не существует, выполните команду **dnf install net-tools**, чтобы установить программное обеспечение **net-tools**, а затем команду **netstat**.

- Остановка службы vsftpd
  
  ```
  # systemctl stop vsftpd
  ```

- Перезапуск службы vsftpd
  
  ```
  # systemctl restart vsftpd
  ```

## Настройка службы vsftpd

### Конфигурационные файлы vsftpd

Изменением конфигурационного файла vsftpd изменяются права пользователей. В [Табл. 1](#table1541615718372) приведены конфигурационные файлы vsftpd с описанием. Вносите изменения в конфигурационные файлы в соответствии с фактической ситуацией. Выполнив команду **man**, можно посмотреть описание других параметров.

**Табл. 1** Конфигурационные файлы vsftpd с описанием

| Конфигурационный файл    | Описание                                                     |
| ------------------------ | ------------------------------------------------------------ |
| /etc/vsftpd/vsftpd.conf  | Главный конфигурационный файл процесса vsftpd. Формат: Параметр=Значение параметра. Параметр и значение параметра не должны быть пустыми.<br/>Выполните следующую команду для просмотра сведений о файле vsftpd.conf:<br/>man 5 vsftpd.conf |
| /etc/pam.d/vsftpd        | Подключаемые модули аутентификации (Pluggable Authentication Module; PAM) используются для проверки подлинности идентификационных данных и ограничивают ряд операций пользователя. |
| /etc/vsftpd/ftpusers     | Список пользователей, которым запрещено пользоваться службой vsftpd. По умолчанию системная учетная запись также включена в этот файл, то есть, по умолчанию системной учетной записи не доступна служба vsftpd. |
| /etc/vsftpd/user\_list   | Список пользователей, которым разрешено или запрещено входить на сервер vsftpd. Вступит или не вступит файл в силу, зависит от перечисленных далее параметров, которые содержатся в основном конфигурационном файле vsftpd.conf:<br /><br/>userlist\_enable: параметр устанавливает необходимость включения механизма использования списка пользователей. Значение **YES** означает, что механизм списка пользователей включен. В этом случае конфигурация userlist\_deny имеет силу. Значение **NO** означает, что механизм списка пользователей отключен.<br/>userlist\_deny: параметр устанавливает запрет на вход пользователей, включенных в список пользователей. **YES** означает, что пользователям такого списка запрещено входить. **NO** означает, что пользователям данной команды разрешается входить.<br/><br />Например, если параметр userlist\_enable имеет значение **YES**, и userlist\_deny также имеет значение **YES**, ни один пользователь из данного списка не имеет права входить. |
| /etc/vsftpd/chroot\_list | Файл ограничивает список пользователей в домашней каталоге. По умолчанию этот файл не существует. Необходимо создать его вручную. Это значение chroot\_list\_file в файле vsftpd.conf.<br /><br/>Функция этого параметра определяется перечисленными далее параметрами, которые включаются в файл vsftpd.conf:<br/>chroot\_local\_user: параметр устанавливает ограничение на использование домашнего каталога всем пользователям. Значение **YES** означает, что доступ к домашнему каталогу ограничен всем пользователям, а значение **NO** означает, что доступ к домашнему каталогу не ограничен ни одному из пользователей.<br/>chroot\_list\_enable: параметр включает список ограниченных пользователей. Значение **YES** означает, что список включен, а значение **NO** означает, что список отключен.<br/><br />Например, если параметр chroot\_local\_user имеет значение **YES**, chroot\_list\_enable — значение **YES** и chroot\_list\_file — /etc/vsftpd/chroot\_list, всем пользователям ограничен доступ к домашнему каталогу, кроме пользователей, находящихся в списке chroot\_list. |
| /usr/sbin/vsftpd         | Уникальный исполняемый файл vsftpd.                          |
| /var/ftp/                | Корневой каталог по умолчанию для входа анонимных пользователей. Корневой каталог связан с домашним каталогом пользователя ftp. |


### Описание конфигурации по умолчанию

> ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:  
Конфигурация в данном документе приведена только в качестве примера. Измените ее содержимое в соответствии с требованиями площадки (например, требованиями по усилению безопасности).

В системе openEuler доступ к службе vsftpd по умолчанию закрыт для анонимных пользователей. Выполните команду **vim**, чтобы посмотреть главный конфигурационный файл. Содержимое файла:

```
$ vim /etc/vsftpd/vsftpd.conf
anonymous_enable=NO
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=NO
listen_ipv6=YES
pam_service_name=vsftpd
userlist_enable=YES
```

В [Табл. 2](#table18185162512499) приведено описание параметров.

**Табл. 2** Описание параметров

| Параметр                | Описание                                                     |
| ----------------------- | ------------------------------------------------------------ |
| anonymous\_enable       | Разрешение на вход для анонимных пользователей. **YES** означает, что анонимным пользователям разрешен вход; **NO** означает, что анонимным пользователям вход запрещен. |
| local\_enable           | Разрешение на вход для локальных пользователей. **YES** означает, что локальным пользователям разрешен вход; **NO** означает, что локальным пользователям вход запрещен. |
| write\_enable           | Параметр устанавливает вошедшим пользователям разрешение на запись. **YES** означает, что функция выгрузки и записи включена, а **NO** означает, что данная функция отключена. |
| ocal\_umask             | Параметр указывает значение umask, когда локальный пользователь добавляет профиль. |
| dirmessage\_enable      | Опция отображения содержимого, на которое пользователям необходимо обратить внимание при доступе к каталогу. Значения: **YES** (опция установлена) и **NO** (опция не установлена). |
| xferlog\_enable         | Опция записи операций выгрузки и загрузки файлов. Значения: **YES** (запись операций ведется) и **NO** (запись операций не ведется). |
| connect\_from\_port\_20 | Опция использования порта 20 для передачи данных в режиме порта. **YES** означает, что порт 20 используется, а **NO** означает, что порт 20 не используется. |
| xferlog\_std\_format    | Опция записи файла журнала операций передачи в стандартном формате xferlog. Значения: **YES** (опция установлена) и **NO** (опция не установлена). |
| listen                  | Опция запуска службы vsftpd в автономном режиме. Значения: **YES** (опция установлена) и **NO** (опция не установлена). |
| pam\_service\_name      | Поддержка управления PAM. Значением является наименование службы, например vsftpd. |
| userlist\_enable        | Опция поддержки функции контроля входа для учетных записей, включенных в файл /etc/vsftpd/user\_list. Значения: **YES** (опция установлена) и **NO** (опция не установлена). |
| tcp\_wrappers           | Опция поддержки механизма межсетевого экрана TCP Wrappers. Значения: **YES** (опция установлена) и **NO** (опция не установлена). |
| listen\_ipv6            | Опция прослушивания запросов IPv6 FTP. Значения: **YES** (опция установлена) и **NO** (опция не установлена). Параметры listen и listen\_ipv6 нельзя включить одновременно. |
### Установка местного времени

#### Обзор

В операционной системе openEuler служба vsftpd по умолчанию использует среднее время по Гринвичу (Greenwich Mean Time; GMT), которое может отличаться от местного времени. Например, время по GMT на 8 часов позже времени Пекина. Время GMT необходимо изменить, установив местное время. В противном случае время сервера и время клиента будут отличаться, что может привести к ошибкам при выгрузке и загрузке файлов.

#### Метод установки

Чтобы установить для vsftpd местное время, выполните следующие шаги как пользователь **root**:

1. Откройте файл vsftpd.conf и измените значение параметра use\_localtime на **YES**. Выполните следующую команду:
   
   ```
   # vim /etc/vsftpd/vsftpd.conf
   ```
   
   Измените содержимое файла следующим образом:
   
   ```
   use_localtime=YES
   ```

2. Перезапустите службу vsftpd.
   
   ```
   # systemctl restart vsftpd
   ```

3. Настройте службу vsftpd на автоматический запуск при включении питания устройства.
   
   ```
   # systemctl enable vsftpd
   ```

### Настройка информации приветствия

Для использования службы vsftpd необходим файл с информацией приветствия. Чтобы сконфигурировать файл welcome.txt для службы vsftpd, выполните следующие шаги как пользователь **root**:

1. Откройте конфигурационный файл vsftpd.conf, добавьте в файл информацию приветствия, сохраните файл и выйдите.
   
   ```
   # vim /etc/vsftpd/vsftpd.conf
   ```
   
   Необходимо добавить следующие строки конфигурации:
   
   ```
   banner_file=/etc/vsftpd/welcome.txt
   ```

2. Создайте информацию приветствия. Для этого откройте файл welcome.txt, внесите в него текст приветствия, сохраните файл и выйдите.
   
   ```
   # vim /etc/vsftpd/welcome.txt
   ```
   
   Пример:
   
   ```
   Welcome to this FTP server!
   ```

### Настройка разрешения на вход для системной учетной записи

Обычно права на вход в систему ограничиваются определенным пользователям. Ограничения настраиваются в соответствии с фактическими потребностями.

Для ограничения входа используются два файла. Значения по умолчанию следующие:

- /etc/vsftpd/ftpusers: этот файл управляется модулем PAM и определяется настройками файла /etc/pam.d/vsftpd.
- /etc/vsftpd/user\_list: этот файл настраивается через список userlist\_file в конфигурационном файле vsftpd.conf и предоставляется службой vsftpd.

Оба файла должны существовать и иметь одинаковое содержимое. В эти два файла можно вносить учетные записи, UID которых меньше 500, с учетом /etc/passwd. Каждая строка выделена под одну учетную запись.

Чтобы ограничить вход системным учетным записям, добавьте их в файлы /etc/vsftpd/ftpusers и /etc/vsftpd/user\_list как пользователь **root**.

Откройте файл user\_list, чтобы просмотреть информацию учетной записи в текущем файле. Команда и ее выходные данные выглядят следующим образом:

```
$ vim /etc/vsftpd/user_list
root
bin
daemon
adm
lp
sync
shutdown
halt
mail
news
uucp
operator
games
nobody
```

## Проверка установки службы FTP

Для проверки можно использовать клиент FTP, предоставляемый openEuler. Команда и ее выходные данные выглядят следующим образом. При появлении запроса введите имя пользователя (существующий пользователь в системе) и пароль. Если на экране появляется сообщение «Login successful», служба FTP успешно установлена.

```
$ ftp localhost
Trying 127.0.0.1...
Connected to localhost (127.0.0.1).
220-Welcome to this FTP server!
220
Name (localhost:root): USERNAME
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> bye
221 Goodbye.
```

> ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:  
Если команда **ftp** не существует, выполните команду **dnf install ftp** как пользователь **root**, чтобы установить программное обеспечение ftp, а затем запустите команду **ftp**.

## Настройка межсетевого экрана

Чтобы открыть службу FTP в Интернет, необходимо сконфигурировать межсетевой экран и SElinux как пользователь **root**.

```
# firewall-cmd --add-service=ftp --permanent
success
# firewall-cmd --reload
success
# setsebool -P ftpd_full_access on
```

## Передача файлов

### Обзор

В этом разделе описывается процедура передачи файлов после запуска службы vsftpd.

### Подключение к серверу

**Формат команды**

**ftp**  \[_hostname_  \|  _ip-address_]

**hostname** — имя сервера, а **ip-адрес** — IP-адрес сервера.

**Требования**

Выполните следующую команду в интерфейсе командной строки операционной системы openEuler:

```
$ ftp ip-address
```

При появлении запроса введите имя пользователя и пароль. Если после успешной аутентификации отображается следующая информация, соединение FTP успешно установлено. В этом случае вы получаете доступ к каталогу подключенного сервера.

```
ftp>
```

При появлении запроса можно ввести нужную команду для выполнения той или иной операции.

- Выведите текущий путь к серверу.
  
  ```
  ftp>pwd
  ```

- Выведите локальный путь. По этому пути можно выгрузить файлы в соответствующее местоположение на сервере FTP.
  
  ```
  ftp>lcd
  ```

- Выйдите из текущего окна и вернитесь в локальный терминал Linux.
  
  ```
  ftp>!
  ```

### Загрузка файла

Для загрузки файлов используется команда get или mget.

**Использование команды get**

- Функция: передача файлов с удаленного хоста на локальный хост.

- Формат команды:  **get**  \[_remote-file_] \[_local-file_]
  
  _remote-file_ — файл удаленного хоста, _local-file_  — файл локального хоста.

- Например, выполните следующую команду, чтобы передать файл /home/openEuler/openEuler.htm, хранящийся на удаленном сервере, в локальный каталог /home/myopenEuler/, изменив имя файла на myopenEuler.htm.
  
  ```
  ftp> get /home/openEuler/openEuler.htm /home/myopenEuler/myopenEuler.htm
  ```

**Использование команды mget**

- Функция: получение пакета файлов с удаленного хоста на локальный хост.

- Формат команды:  **mget**  \[_remote-file_]
  
  _remote-file_  — файл на удаленном хосте.

- Например, чтобы получить все файлы каталога /home/openEuler/ на сервере, выполните следующую команду:
  
  ```
  ftp> cd /home/openEuler/
  ftp> mget *.*
  ```
  
  > ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:
  > 
  > - В этом случае сообщение отображается при каждой загрузке файла. Чтобы блокировать данную информацию, выполните команду **prompt off** перед выполнением команды **mget \*.\***  .
  > - Файлы загружаются в текущий каталог на хосте Linux. Например, если выполнить команду ftp в каталоге /home/myopenEuler/, все файлы загрузятся в каталог /home/myopenEuler/.

### Выгрузка файла

Для выгрузки файлов используется команда put или mput.

**Использование команды put**

- Функция: передача локального файла на удаленный хост.

- Формат команды:  **put**  \[_local-file_] \[_remote-file_]
  
  _remote-file_ — файл удаленного хоста, _local-file_  — файл локального хоста.

- Например, выполните следующую команду, чтобы передать локальный файл myopenEuler.htm на удаленный хост /home/openEuler/ и изменить имя файла на openEuler.htm:
  
  ```
  ftp> put myopenEuler.htm /home/openEuler/openEuler.htm
  ```

**Использование команды mput**

- Функция: передача пакета файлов с локального хоста на удаленный хост.

- Формат команды:  **mput**  \[_local-file_]
  
  _local-file_  — файл на локальном хосте.

- Например, выполните следующую команду, чтобы выгрузить все файлы HTM, хранящиеся в локальном каталоге, в каталог /home/openEuler/ на сервере:
  
  ```
  ftp> cd /home/openEuler/
  ftp> mput *.htm
  ```

### Удаление файла

Файлы удаляются командой delete или mdelete.

**Использование команды delete**

- Функция: удаление одного или нескольких файлов с удаленного сервера.

- Формат команды:  **delete**  \[_remote-file_]
  
  _remote-file_  — файл на удаленном хосте.

- Например, чтобы удалить /файл /home/openEuler/openEuler.htm с удаленного сервера, выполните следующую команду:
  
  ```
  ftp> cd /home/openEuler/
  ftp> delete openEuler.htm
  ```

**Использование команды mdelete**

- Функция: удаление файлов с удаленного сервера. Эта функция используется для удаления файлов пакетами.

- Формат команды:  **mdelete**  \[_remote-file_]
  
  _remote-file_  — файл на удаленном хосте.

- Например, чтобы удалить все файлы, имена которых начинаются с **a**, из каталога /home/openEuler/ на удаленном сервере, выполните следующую команду:
  
  ```
  ftp> cd /home/openEuler/
  ftp> mdelete a*
  ```

### Отключение от сервера

Выполните команду **bye**, чтобы отключиться от сервера.

```
ftp> bye 
```