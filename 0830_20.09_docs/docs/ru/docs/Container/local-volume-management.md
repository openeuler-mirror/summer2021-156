# Управление локальным томом

<!-- TOC -->
- [Управление локальным томом](#local-volume-management)
  - [Обзор](#overview)
  - [Меры предосторожности](#precautions)
  - [Использование](#usage)
    - [Монтирование данных с использованием параметра -v](#using-the--v-option-to-mount-data)
      - [Формат](#format)
      - [Функции](#functions)
      - [Описание параметров](#parameter-description)
      - [Примеры](#examples)
    - [Монтирование данных с использованием параметра --mount](#using-the---mount-option-to-mount-data)
      - [Формат](#format-1)
      - [Функции](#functions-1)
      - [Описание параметров](#parameter-description-1)
      - [Примеры](#examples-1)
    - [Повторное использование конфигурации монтирования в других контейнерах](#reusing-the-mounting-configuration-in-other-containers)
      - [Формат](#format-2)
      - [Функции](#functions-2)
      - [Описание параметров](#parameter-description-2)
      - [Примеры](#examples-2)
    - [Использование анонимного тома в образе](#using-the-anonymous-volume-in-an-image)
    - [Запрос тома](#querying-a-volume)
      - [Формат](#format-3)
      - [Функции](#functions-3)
      - [Описание параметров](#parameter-description-3)
      - [Примеры](#examples-3)
    - [Удаление тома](#deleting-a-volume)
      - [Формат](#format-4)
      - [Функции](#functions-4)
      - [Описание параметров](#parameter-description-4)
      - [Примеры](#examples-4)
    - [Меры предосторожности](#precautions-1)
      - [Правила обработки при возникновении конфликтов](#conflict-combination-rules)
      - [Различия между iSula и Docker](#differences-between-isula-and-docker)

<!-- /TOC -->
## Обзор

С удалением контейнера, управляемого iSula, удаляются также все содержащиеся в контейнере данные. Если необходимо сохранить данные после удаления контейнера, требуется механизм сохранения данных. С помощью движка iSula в среде выполнения монтируются файлы, каталоги или тома хоста в контейнер. Данные, которые необходимо сохранить, можно записать в точку монтирования в контейнере. После удаления контейнера файлы, каталоги и тома на хосте сохранятся. Удалить любой файл или каталог на хосте можно вручную. Том удаляется командой iSula. В настоящее время iSula поддерживает только управление локальным томом. Локальные тома классифицируются на именованные и анонимные тома. Том, имя которого задано пользователем, называется именованным томом. Если пользователь не указывает имя тома, iSula автоматически генерирует имя (64-разрядное случайное число), т.е. такой том является анонимным.

Далее описан метод управления локальными томами с помощью iSula.

## Меры предосторожности

- Имя тома содержит от 2 до 64 символов и соответствует регулярному выражению ^[a-zA-Z0-9](){1,63}$. То есть, первым символом имени тома должна быть буква или цифра, а остальными символами могут быть буквы, цифры, знаки подчеркивания (\_), точки и дефисы (-).
- Если при создании контейнера в точке монтирования контейнера, соответствующего данному тому, существуют данные, эти данные копируются в том по умолчанию. Сбой в работе движка iSula или его перезапуск либо отключение питания системы могут привести к тому, что данные в томе будут неполными. В этом случае необходимо вручную удалить том или данные в томе, чтобы убедиться в их корректности и полноте.

## Использование

### Монтирование данных с использованием параметра -v

#### **Формат**

```shell
isula run -v [SRC:]DST[:MODE,MODE...] IMAGE
```

#### **Функции**

Параметр v/--volume используется во время создания и запуска контейнера для монтирования файлов, каталогов или томов на хосте в контейнер для сохранения данных.

#### **Описание параметров**

- SRC: путь к монтируемому на хосте файлу, каталогу или тому. Если значением является абсолютный путь, на хосте монтируется файл или папка. Если значением является имя тома, то монтируется том. Если этот параметр не указан, монтируется анонимный том. Если папка или том не существует, iSula сначала создает их, а затем монтирует.
- DST: путь монтирования на хосте. Значением должен быть абсолютный путь.
- MODE: когда монтируемый источник является каталогом или файлом, действительными параметрами будут ro, rw, z, Z, private, rprivate, slave, rslave, shared, rshared. Настроить можно только один параметр одного типа. Если источником является том, действительными параметрами являются ro, rw, z, Z и nocopy. Настроить можно только один параметр одного типа. Атрибуты перечисляются через запятую (,). Описание параметров:

| Параметр | Описание                                                     |
| -------- | ------------------------------------------------------------ |
| ro       | Точка монтирования в контейнере подключается в режиме «только чтение». |
| rw       | Точка монтирования в контейнере подключается в режиме чтение/запись. |
| z        | Если SELinux включен, добавьте во время монтирования метку общего доступа к SELinux. |
| Z        | Если SELinux включен, добавьте во время монтирования метку частного доступа к SELinux. |
| private  | Точка монтирования в контейнере подключается в режиме частного распространения. |
| rprivate | Точка монтирования в контейнере рекурсивно подключается в режиме частного распространения. |
| slave    | Точка монтирования в контейнере подключается в режиме частного зависимого распространения. |
| rslave   | Точка монтирования в контейнере рекурсивно подключается в режиме частного зависимого распространения. |
| shared   | Точка монтирования в контейнере подключается в режиме общего распространения. |
| rshared  | Точка монтирования в контейнере рекурсивно подключается в режиме общего распространения. |
| nocopy   | Данные в точке монтирования не копируются. Если этот параметр не установлен, данные копируются по умолчанию. Если данные уже существуют в томе, они не копируются. |
#### **Примеры**

В следующем примере запускается контейнер на основе BusyBox, создается или монтируется том с именем vol в каталог /vol контейнера и устанавливается точка монтирования в режиме «только чтение». Если данные в точке монтирования в контейнере уже существуют, они копируются.

```shell
isula run -v vol:/vol:ro,nocopy busybox
```

### Монтирование данных с использованием параметра --mount

#### **Формат**

```shell
isula run --mount [type=TYPE,][src=SRC,]dst=DST[,KEY=VALUE] busybox
```

#### **Функции**

Параметр -mount используется во время создания и запуска контейнера для монтирования файлов, каталогов или томов на хосте в контейнер с целью сохранения данных.

#### **Описание параметров**

- type: тип данных, смонтированных в контейнер. Значения: bind, volume или squashfs. Если этот параметр не указан, используется значение по умолчанию volume.
- src: путь к монтируемому на хосте файлу, каталогу или тому. Если значением является абсолютный путь, на хосте монтируется файл или каталог. Если значением является имя тома, то монтируется том. Если этот параметр не указан, том является анонимным. Если папка или том не существует, iSula сначала создает их, а затем монтирует. Ключевое слово src также называется источником.
- dst: путь монтирования на хосте. Значением должен быть абсолютный путь. Ключевое слово dst также называется объектом назначения или целевым объектом.
- KEY=VALUE: параметр --mount. Значения следующие:

| KEY                            | VALUE                                                        |
| ------------------------------ | ------------------------------------------------------------ |
| selinux-opts/bind-selinux-opts | z или Z. z означает, что если включен SELinux, во время монтирования добавляется метка общего доступа к SELinux. Z означает, что если включен SELinux, во время монтирования добавляется метка частного доступа к SELinux. |
| ro/readonly                    | 0/false означает, что монтирование осуществляется в режиме «чтение/запись». 1/true означает, что монтирование осуществляется в режиме «только чтение». Если этот параметр не указан, монтирование осуществляется в режиме «только чтение». Этот параметр поддерживается только в том случае, если тип имеет значение bind. |
| volume-nocopy                  | Данные в точке монтирования не копируются. Если этот параметр не установлен, данные копируются по умолчанию. Если данные уже существуют в томе, они не копируются. Этот параметр поддерживается только в том случае, если тип имеет значение volume. |


#### **Примеры**

В следующем примере запускается контейнер на основе BusyBox, создается или монтируется том с именем vol в каталог /vol контейнера и устанавливается точка монтирования в режиме «только чтение». Если данные в точке монтирования в контейнере уже существуют, они копируются.

```shell
isula run --mount type=volume,src=vol,dst=/vol,ro=true,volume-nocopy=true busybox
```

### Повторное использование конфигурации монтирования в других контейнерах

#### **Формат**

```shell
isula run --volumes-from CON1[:MODE] busybox
```

#### **Функции**

Во время создания и запуска контейнера с помощью параметра --volumes-from указывается, что конфигурация точки монтирования включает конфигурацию точки монтирования контейнера CON1. Можно настроить несколько параметров -volumes-from.

#### **Описание параметров**

- CON1: имя или идентификатор контейнера, точка монтирования которого повторно используется.
- MODE: если значение **ro**, точка монтирования подключается в режиме «только чтение», если значение **rw**, точка монтирования подключается в режиме «чтение/запись».

#### **Примеры**

Предположим, что для контейнера с именем container1 сконфигурирован том vol1 в каталоге контейнера /vol1, а для контейнера с именем container2 сконфигурирован том vol2 в каталоге контейнера /vol2. Запустите новый контейнер, чтобы повторно использовать конфигурацию монтирования container1 и container2. То есть, том vol1 монтируется в каталог /vol1 контейнера, а том vol2 монтируется в каталог /vol2 контейнера.

```shell
isula run --volumes-from container1 --volumes-from container2 busbyox
```

### Использование анонимного тома в образе

Для использования анонимного тома в образе настройки не требуются. Если в образе сконфигурирован анонимный том, iSula автоматически создает анонимный том и монтирует его по указанному пути в образе в среде выполнения контейнера. Для сохранения данных можно записывать их в точку монтирования анонимного тома в контейнере.

### Запрос тома

#### **Формат**

```shell
isula volume ls [OPTIONS]
```

#### **Функции**

Эта команда используется для запроса всех томов, которыми управляет движок iSula.

#### **Описание параметров**

Параметр:

- -q,--quit: если этот параметр не указан, по умолчанию запрашиваются только данные драйвера тома и имя тома. Если параметр указан, запрашивается только имя тома.

#### **Примеры**

Эта команда запрашивает все тома, управляемые движком iSula, и возвращает только имя тома.

```shell
isula volume ls -q
```

### Удаление тома

#### **Формат**

```
isula volume rm [OPTIONS] VOLUME [VOLUME...]
isula volume prune [OPTIONS]
```

#### **Функции**

- rm: удаление указанного тома. Если том используется контейнером, удалить его невозможно.
- prune: удаление всех томов, которые не используются контейнерами.

#### **Описание параметров**

Параметры в команде prune:

- \- f,--force: в соответствии с данной настройкой система не выводит сообщение-подтверждение удаления тома. По умолчанию выводится сообщение о риске. Для продолжения операции необходимо ввести y.

#### **Примеры**

В данном примере удаляются тома vol1 и vol2.

```shell
isula volume rm vol1 vol2
```

В данном примере удаляются все неиспользуемые тома в следующем формате. Сообщение о риске не выводится.

```shell
isula volume prune -f
```

### Меры предосторожности

#### Правила обработки при возникновении конфликтов

Если возникает конфликт точки монтирования тома, выполните следующие операции:

- Если конфликтуют настройки -v и --mount, возвращается сообщение об ошибке.
- Если конфликтует конфигурация, полученная в параметре --volumes-from, с настройкой -v или 
  --mount, такая конфигурация отбрасывается.
- Если конфигурация анонимного тома в образе конфликтует с настройкой -v, --mount или 
  --volumes-from, такая конфигурация отбрасывается.

#### Различия между iSula и Docker

| Принцип, используемый в iSula                                | Принцип, используемый в Docker                               |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| Имя тома может включать максимум 64 символа.                 | Длина имени тома не ограничена.                              |
| Если монтируемый источник не существует, создается параметр --mount. | Если монтируемый источник не существует, передается ошибка.  |
| Параметр --mount поддерживает конфигурацию параметров z или Z в bind-selinux-opts и selinux-opts. | Параметр --mount не поддерживает конфигурацию параметров в bind-selinux-opts и selinux-opts. |
| При возникновении конфликтов точек монтирования обработка не производится. | Анонимный том, указанный параметром -v, обрабатывается в образе как анонимный том. |
| Команда prune отображает перераспределенное пространство тома. | Команда prune не отображает перераспределенное пространство тома. |
| \- v, --mount и --volumes-from настраиваются в файле hostconfig, а анонимный том настраивается в файле config. | Анонимный том, указанный параметром -v, настраивается в файле config, а остальные конфигурации настраиваются в файле hostconfig. |
