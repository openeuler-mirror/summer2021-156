# Настройка сети для безопасного контейнера

- [Настройка сети для безопасного контейнера](#configuring-networking-for-a-secure-container)

## Поддержка сети на основе TAP

Технология безопасных контейнеров реализуется на базе виртуальных машин QEMU. С точки зрения физической машины безопасный контейнер эквивалентен ВМ. Поэтому такой контейнер может подключить виртуальную машину к внешней сети в сетевой подсистеме Neutron с использованием технологии ответвления трафика (Test Access Point; TAP). Не требуется выполнять операции создания и соединения по мостовой схеме устройств TAP. Необходимо только добавить в горячем режиме указанное TAP-устройство (с существующим хостом) в виртуальную машину в pause-контейнере и обновить информацию NIC.

Используемые команды:

1. Выполните следующую команду, чтобы добавить TAP NIC для запущенного контейнера:
   
   ```
   $ cat ./test-iface.json | kata-runtime kata-network add-iface 6ec7a98 -
   ```
   
   В данной команде **6ec7a98** является идентификатором усеченного контейнера (truncated container), а **test-infs.json** — это файл, который описывает информацию NIC. Пример:
   
   ```
   {
       "device": "tap-test", 
       "name": "eth-test", 
       "IPAddresses": [
           {
               "address": "172.16.0.3", 
               "mask": "16"
           }
       ], 
       "hwAddr":"02:42:20:6f:a3:69",
       "mtu": 1500,
       "vhostUserSocket":"/usr/local/var/run/openvswitch/vhost-user1",
       "queues":5
   }
   ```
   
   Описание параметров, содержащихся в файле JSON:
   
   | **Параметр**    | **Обязательный/необязательный** | Описание                                                     |
   | --------------- | ------------------------------- | ------------------------------------------------------------ |
   | device          | Обязательный                    | Имя карты NIC на хосте. Значение может содержать максимум 15 символов, включая буквы, цифры, знаки подчеркивания (_), дефисы (-) и точки (.). Значение должно начинаться с буквы. Имя устройства должно быть уникальным в пределах одного хоста. |
   | name            | Обязательный                    | Имя карты NIC в контейнере. Значение может содержать максимум 15 символов, включая буквы, цифры, знаки подчеркивания (_), дефисы (-) и точки (.). Значение должно начинаться с буквы. Имя должно быть уникальным в пределах одной песочницы. |
   | IPAddresses     | Необязательный                  | IP-адрес карты NIC. В настоящее время для каждой карты NIC можно настроить один IP-адрес. Если IP-адрес для NIC не настроен, в контейнере также не будет настроен IP-адрес. |
   | hwAddr          | Обязательный                    | MAC-адрес карты NIC.                                         |
   | mtu             | Обязательный                    | MTU карты NIC. Диапазон принимаемых значений — от 46 до 9600. |
   | vhostUserSocket | Необязательный                  | Путь к сокету для опроса DPDK. Путь может состоять максимум из 128 байт. В наименовании могут содержаться цифры, буквы и дефисы (-). Имя пути должно начинаться с буквы. |
   | queues          | Необязательный                  | Количество очередей NIC. Если этот параметр не указан, используется значение по умолчанию **0**. |
   
   Содержимое вывода команды **kata-runtime kata-network add-iface**, добавляющей карты NIC:
   
   - При условии успешного выполнения команды информация о карте NIC в виде файла JSON возвращается с **standard output (stdout)**. Содержимое файла формата JSON совпадает с вводной информацией NIC.
     
     Пример.
     
     ```
     $ kata-runtime kata-network add-iface <container-id> net.json 
     {"device":"tap_test","name":"eth-test","IPAddresses":[{"Family":2,"Address":"173.85.100.1","Mask":"24"}],"mtu":1500,"hwAddr":"02:42:20:6e:03:01","pciAddr":"01.0/00"}
     ```
   
   - Если команда не выполняется, то от **stdout** возвращается нулевое значение.
     
     Пример.
     
     ```
     $ kata-runtime kata-network add-iface <container-id> netbad.json 2>/dev/null
     null
     ```
   
   > ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:  
   Если для успешно добавленной карты NIC указан IP-адрес, Kata добавляет маршрут по умолчанию, пункт назначения которого находится в том же сегменте сети, что и IP-адрес NIC. В приведенном примере после добавления NIC в контейнер добавляется следующий маршрут:
   > 
   > ```
   > [root@6ec7a98 /]# ip route  
   > 172.16.0.0/16 dev eth-test proto kernel scope link src 172.16.0.3  
   > ```
   
2. Просмотр добавленных карт NIC выполняется следующей командой:
   
   ```
   $ kata-runtime kata-network list-ifaces 6ec7a98
   [{"name":"eth-test","mac":"02:42:20:6f:a3:69","ip":["172.16.0.3/16"],"mtu":1500}]
   ```
   
   Отображается информация о добавленных картах NIC.
   
   Содержимое вывода команды **kata-runtime kata-network list-ifaces**, которая выдает список карт NIC:
   
   - Если команда успешно выполнена, от **stdout** возвращается информация обо всех NIC в pod-группе контейнеров в файле формата JSON.
     
     Если в pod-группу контейнеров добавлены несколько NIC, информация NIC возвращается в формате массива JSON.
     
     ```
     $ kata-runtime kata-network list-ifaces <container-id>
     [{"name":"container_eth","mac":"02:42:20:6e:a2:59","ip":["172.17.25.23/8"],"mtu":1500},{"name":"container_eth_2","mac":"02:90:50:6b:a2:29","ip":["192.168.0.34/24"],"mtu":1500}]
     ```
     
     Если в pod-группу контейнеров не добавлена ни одна карта NIC, то от **stdout** возвращается нулевое значение.
     
     ```
     $ kata-runtime kata-network list-ifaces <container-id>
     null
     ```
   
   - Если команда не выполняется, от **stdout** возвращается нулевое значение, а от **standard error (stderr)** возвращается описание ошибки.
     
     Пример.
     
     ```
     $ kata-runtime kata-network list-ifaces <container-id>
     null
     ```

3. Добавьте маршрут для указанной карты NIC.
   
   ```
   $ cat ./test-route.json | kata-runtime kata-network add-route 6ec7a98 -
   [{"dest":"default","gateway":"172.16.0.1","device":"eth-test"}]
   ```
   
   Содержимое вывода команды **kata-runtime kata-network add-route**, добавляющей маршрут к указанной карте NIC:
   
   - При условии успешного выполнения команды от **stdout** возвращается информация о добавленном маршруте в виде файла JSON.
     
     Пример.
     
     ```
     $ kata-runtime kata-network add-route <container-id> route.json 
     [{"dest":"177.17.0.0/24","gateway":"177.17.25.1","device":"netport_test_1"}]
     ```
   
   - Если команда не выполняется, от **stdout** возвращается нулевое значение, а от **standard error (stderr)** возвращается описание ошибки.
     
     Пример.
     
     ```
     $ kata-runtime kata-network add-route <container-id> routebad.json 2>/dev/null
     null
     ```
   
   Описание основных полей:
   
   - **dest**: сегмент сети, соответствующий маршруту. Значение имеет формат \<_ip_>/\<_mask_>. \<_ip_> — обязательный компонент значения. Три варианта настройки:
     1. Настроены и IP-адрес, и маска.
     2. Если настроен только IP-адрес, маска по умолчанию — 32.
     3. Если настроены параметры **"dest":"default"**, пункт назначения по умолчанию отсутствует. В этом случае необходимо сконфигурировать шлюз.
     
   - **gateway**: установка шлюза для перехода на следующий узел по маршруту. Если настроены параметры **"dest":"default"**, шлюз является обязательным. В остальных случаях этот параметр является необязательным.
   
   - **device**: имя карты NIC, соответствующей маршруту, обязательный параметр. Значение может состоять максимум из 15 символов.
   
   > ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:  
   Если в контейнер добавляется маршрут для устройства шлейфа **lo**, именем устройства, соответствующего полю **device** в конфигурационном файле маршрута, будет имя **lo**.

4. Удалите указанный маршрут следующей командой:
   
   ```
   $ cat ./test-route.json | kata-runtime kata-network del-route 6ec7a98 -
   ```
   
   Поля в файле **test-route.json** те же, что и поля в файле JSON с настройками добавления маршрута.
   
   Содержимое вывода команды **kata-runtime kata-network del-route**, удаляющей указанный маршрут:
   
   - При условии успешного выполнения команды от **stdout** возвращается информация о добавленном маршруте в виде файла JSON.
     
     Пример.
     
     ```
     $ kata-runtime kata-network del-route <container-id> route.json 
     [{"dest":"177.17.0.0/24","gateway":"177.17.25.1","device":"netport_test_1"}]
     ```
   
   - Если команда не выполняется, от **stdout** возвращается нулевое значение, а от **standard error (stderr)** возвращается описание ошибки.
     
     Пример.
     
     ```
     $ kata-runtime kata-network del-route <container-id> routebad.json 2>/dev/null
     null
     ```
   
   > ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:
   > 
   > - Здесь **dest** является обязательным параметром, а **device** и **gateway** — необязательными. Kata выполняет поиск значений в различных полях по нечеткому совпадению и удаляет соответствующие правила маршрутизации. Например, если в поле **dest** установлен IP-адрес, все правила этого IP-адреса будут удалены.
   > - Если маршрут устройства шлейфа **lo** удаляется из контейнера, именем устройства, соответствующего полю **device** в конфигурационном файле маршрута, будет имя **lo**.

5. Удалите карту NIC, выполнив следующую команду:
   
   ```
   $ cat ./test-iface.json | kata-runtime kata-network del-iface 6ec7a98 -
   ```
   
   > ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:  
Удалить карту NIC можно только на основании поля **name** в контейнере NIC. Kata не идентифицирует остальные поля.
   
   Содержимое вывода команды **kata-runtime kata-network del-iface**, удаляющей карты NIC:
   
   - Если команда успешно выполняется, то от **stdout** возвращается нулевое значение.
     
     Пример.
     
     ```
     $ kata-runtime kata-network del-iface <container-id> net.json
     null
     ```
   
   - Если команда не выполняется, от **stdout** возвращается информация о картах NIC, которые не удалось удалить из файла JSON, а от **stderr** возвращается описание ошибки.
     
     Пример.
     
     ```
     $ kata-runtime kata-network del-iface <container-id> net.json
     {"device":"tapname_fun_012","name":"netport_test_1","IPAddresses":[{"Family":0,"Address":"177.17.0.1","Mask":"8"}],"mtu":1500,"hwAddr":"02:42:20:6e:a2:59","linkType":"tap"}
     ```

Вышеприведенные команды являются стандартными. Подробную информацию о командах CLI см. раздел [API](#apis-32.md#EN-US_TOPIC_0184808188).

## Подсистема Kata IPVS

Безопасный контейнер предоставляет API для добавления команды **ipvs** и установки для контейнера правила IPVS. Функции включают добавление, редактирование и удаление виртуальных служб, добавление, редактирование и удаление физических серверов, запрос информации о службе IPVS, установку времени ожидания соединения, удаление кэша соединений системы и групповой импорт правил.

1. Добавьте адрес виртуальной службы для контейнера.
   
   ```
   kata-runtime kata-ipvs ipvsadm --parameters "--add-service --tcp-service 172.17.0.7:80 --scheduler rr --persistent 3000" <container-id>
   ```

2. Измените параметры виртуальной службы контейнера.
   
   ```
   kata-runtime kata-ipvs ipvsadm --parameters "--edit-service --tcp-service 172.17.0.7:80 --scheduler rr --persistent 5000" <container-id>
   ```

3. Удалите адрес виртуальной службы контейнера.
   
   ```
   kata-runtime kata-ipvs ipvsadm --parameters "--delete-service --tcp-service 172.17.0.7:80" <container-id>
   ```

4. Добавьте физический сервер для адреса виртуальной службы.
   
   ```
   kata-runtime kata-ipvs ipvsadm --parameters "--add-server --tcp-service 172.17.0.7:80 --real-server 172.17.0.4:80 --weight 100" <container-id>
   ```

5. Измените параметры физического сервера контейнера.
   
   ```
   kata-runtime kata-ipvs ipvsadm --parameters "--edit-server --tcp-service 172.17.0.7:80 --real-server 172.17.0.4:80 --weight 200" <container-id>
   ```

6. Удалите физический сервер из контейнера.
   
   ```
   kata-runtime kata-ipvs ipvsadm --parameters "--delete-server --tcp-service 172.17.0.7:80 --real-server 172.17.0.4:80" <container-id>
   ```

7. Запросите информацию о службе.
   
   ```
   kata-runtime kata-ipvs ipvsadm --parameters "--list" <container-id>
   ```

8. Последовательный импорт правил занимает много времени. Правила можно записать в файл и импортировать их группой.
   
   ```
   kata-runtime kata-ipvs ipvsadm --restore - < <rule file path> <container-id>
   ```
   
   > ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:  
По умолчанию для добавления одного реального сервера используется режим NAT. Чтобы добавить физические серверы группой, необходимо вручную добавить опцию **-m** для использования режима NAT.  
Далее приведен пример содержимого файла правил:  
-A -t 10.10.11.12:100 -s rr -p  3000  
-a -t 10.10.11.12:100 -r  172.16.0.1:80 -m  
-a -t 10.10.11.12:100 -r  172.16.0.1:81 -m  
-a -t 10.10.11.12:100 -r 172.16.0.1:82  -m

9. Очистите кэш соединений системы.
   
   ```
   kata-runtime kata-ipvs cleanup --parameters "--orig-dst 172.17.0.4 --protonum tcp" <container-id>
   ```

10. Установите интервал времени ожидания для соединений TCP, TCP FIN или UDP.
    
    ```
    kata-runtime kata-ipvs ipvsadm --parameters "--set 100 100 200" <container-id>
    ```
    
    > ![](./public_sys-resources/icon-note.gif) **ПРИМЕЧАНИЕ**:
    > 
    > 1. Каждый контейнер поддерживает максимум 20000 правил iptables (5000 служб и три сервера/сервиса). add-service и add-server являются правилами.
    > 2. Перед импортом правил групповым методом необходимо выполнить сброс существующих правил.
    > 3. Параллельно они не используются.
    > 4. Вышеприведенные команды являются стандартными. Подробную информацию о командах CLI см. раздел [API](#apis-32.md#EN-US_TOPIC_0184808188).