# Руководство по инструментам

- [vmtop](#vmtop)

## vmtop

### Обзор

vmtop — это инструмент пользовательского режима, работающий на хост-машине. С помощью vmtop можно динамически в режиме реального времени просматривать загрузку таких ресурсов виртуальной машины, как процессор, память и количество trap-сообщений о системном прерывании от виртуального процессора. Поэтому vmtop можно использовать для локализации проблем с виртуализацией и оптимизации производительности.

#### Поддержка разных архитектур

В настоящее время vmtop поддерживает процессорные архитектуры AArch64 и x86\_64.

#### Описание элемента отображения

Элементы отображения vmtop меняются в зависимости от архитектуры процессора. В данном документе приведено описание каждого элемента отображения и того, отображается ли он в соответствующей архитектуре. Примечание. Следующая разница выборки — это разница между двумя результатами данных, полученными за указанный интервал времени.

##### **Элементы отображения архитектур AArch64 и x86\_64**

- VM/task-name: имя виртуальной машины/процесса
- DID: идентификатор виртуальной машины
- PID: PID-идентификатор процесса qemu виртуальной машины
- %CPU: ресурсы процессора, занимаемые отдельным процессом
- EXTsum: количество завершений работы KVM (погрешность выборки)
- S: статус процесса
- P: физические ресурсы процессора, занимаемые отдельным процессом
- %ST: процент времени приоритетного занятия ресурсов процессора
- %GUE: процент времени занятия ресурсов процессора виртуальной машиной
- %HYP: процент затрат ресурсов на виртуализацию

##### Элементы отображения только для архитектуры AArch64

- EXThvc: количество завершений работы hvc (погрешность выборки)
- EXTwfe: количество завершений работы wfe (погрешность выборки)
- EXTwfi: количество завершений работы wfi (погрешность выборки)
- EXTmmioU: количество завершений работы mmioU (погрешность выборки)
- EXTmmioK: количество завершений работы mmioK (погрешность выборки)
- EXTfp: количество завершений работы fp (погрешность выборки)
- EXTirq: количество завершений работы irq (погрешность выборки)
- EXTsys64: количество завершений работы sys64 (погрешность выборки)
- EXTmabt: количество аварийных завершений работы mem (погрешность выборки)

##### Элементы отображения только для архитектуры x86\_64

- PFfix: количество сбоев страниц (погрешность выборки)
- PFgu: количество попаданий сбоев страниц в гостевую ОС (погрешность выборки)
- INvlpg: количество попыток очистки элемента TLB (один из элементов TLB, который не фиксирован)
- EXTio: количество завершений работы io VM (погрешность выборки)
- EXTmmio: количество завершений работы mmio VM (погрешность выборки)
- EXThalt: количество завершений работы halt VM (погрешность выборки)
- EXTsig: количество завершений работы VM, вызванных обработкой сигналов (погрешность выборки)
- EXTirq: количество завершений работы VM, вызванных прерываниями (погрешность выборки)
- EXTnmiW: количество завершений работы VM, вызванных немаскируемыми прерываниями (погрешность выборки)
- EXTirqW: механизм Interruptwindow. если функция прерывания включена, exit используется для ввода прерываний (погрешность выборки)
- IrqIn: количество попаданий прерываний IRQ (погрешность выборки)
- NmiIn: количество попаданий прерываний NMI (погрешность выборки)
- TLBfl: количество попыток очистки TLB (погрешность выборки)
- HostReL: количество раз перегрузки состояния хоста (погрешность выборки)
- Hyperv: количество раз, когда гостевая ОС симулируется для вызова hypercal в режиме вспомогательной виртуализации (погрешность выборки)
- EXTcr: количество завершений доступа к регистру CR (погрешность выборки)
- EXTrmsr: количество завершений работы MSR чтения (погрешность выборки)
- EXTwmsr: количество завершений работы MSR записи (погрешность выборки)
- EXTapic: количество записей APIC (погрешность выборки)
- EXTeptv: количество завершений работы из-за сбоев страниц Ept (погрешность выборки)
- EXTeptm: количество аварийных завершений Ept (погрешность выборки)
- EXTpau: количество остановок и завершений работы VCPU (погрешность выборки)

### Использование инструмента

vmtop — это инструмент командной строки. Инструмент vmtop можно запустить непосредственно в режиме командной строки. Кроме того, в vmtop доступны различные опции, используемые для запроса различных данных.

#### Синтаксис

```sh
vmtop [option]
```

#### Описание опций

- -d: установка интервала обновления, в секундах.
- -H: вывод информации по потокам виртуальной машины.
- -n: задание количества обновлений и завершений после обновления.
- -b: отображение группового режима (Batch), который можно использовать для перенаправления в файл.
- -h: вывод справочной информации.
- -v: вывод информации о версиях.
- -p: мониторинг виртуальной машины с указанным идентификатором.

#### Клавиша быстрого выбора команд

Данные клавиши используются для быстрого выбора команд во время работы vmtop.

- H: вывод информации по потокам виртуальной машины или остановка вывода. Информация отображается по умолчанию.
- Вверх/вниз: перемещение вверх или вниз по списку виртуальных машин.
- Влево/право: перемещение курсора влево или вправо для отображения столбцов, скрытых из-за нехватки ширины экрана.
- f: вход в режим редактирования элемента мониторинга и выбор элемента мониторинга, который требуется включить.
- q: выход из процесса vmtop.

### Пример

Выполните на хосте команду vmtop.

```sh
vmtop
```

Выходные данные команды выглядят следующим образом:

```sh
vmtop - 2020-09-14 09:54:48 - 1.0
Domains: 1 running

  DID  VM/task-name     PID  %CPU    EXThvc    EXTwfe    EXTwfi  EXTmmioU  EXTmmioK     EXTfp    EXTirq  EXTsys64   EXTmabt    EXTsum    S    P   %ST  %GUE  %HYP
    2       example 4054916  13.0         0         0      1206        10         0       144        62       174         0      1452    S  106   0.0  99.7  16.0
```

Из этих данных понятно, что на хосте находится только одна виртуальная машина с именем «example». Идентификатор — 2. Загрузка ресурсов процессора — 13,0%.  Общее количество trap-сообщений о системных прерываниях в секунду — 1452. Физический процессор, занятый процессом виртуальной машины — CPU 106. Процент времени занятия ресурсов процессора виртуальной машиной — 99,7%.

1. Вывод информации по потокам виртуальной машины. Нажмите H, чтобы отобразить информацию по потокам.

```sh
vmtop - 2020-09-14 10:11:27 - 1.0
Domains: 1 running

  DID  VM/task-name     PID  %CPU    EXThvc    EXTwfe    EXTwfi  EXTmmioU  EXTmmioK     EXTfp    EXTirq  EXTsys64   EXTmabt    EXTsum    S    P   %ST  %GUE  %HYP
    2       example 4054916  13.0         0         0    1191        17         4       120        76       147         0      1435    S  119   0.0 123.7   4.0
   |_      qemu-kvm 4054916   0.0         0         0         0         0         0         0         0         0         0         0    S  119   0.0   0.0   0.0
   |_      qemu-kvm 4054928   0.0         0         0         0         0         0         0         0         0         0         0    S  119   0.0   0.0   0.0
   |_  signalfd_com 4054929   0.0         0         0         0         0         0         0         0         0         0         0    S  120   0.0   0.0   0.0
   |_  IO mon_iothr 4054932   0.0         0         0         0         0         0         0         0         0         0         0    S  117   0.0   0.0   0.0
   |_     CPU 0/KVM 4054933   3.0         0         0       280         6         4        28        19        41         0       350    S  105   0.0  27.9   0.0
   |_     CPU 1/KVM 4054934   3.0         0         0       260         0         0        16        12        36         0       308    S   31   0.0  20.0   0.0
   |_     CPU 2/KVM 4054935   3.0         0         0       341         0         0        44        20        26         0       387    R  108   0.0  27.9   4.0
   |_     CPU 3/KVM 4054936   5.0         0         0       310        11         0        32        25        44         0       390    S  103   0.0  47.9   0.0
   |_   memory_lock 4054940   0.0         0         0         0         0         0         0         0         0         0         0    S  126   0.0   0.0   0.0
   |_    vnc_worker 4054944   0.0         0         0         0         0         0         0         0         0         0         0    S  118   0.0   0.0   0.0
   |_        worker 4143738   0.0         0         0         0         0         0         0         0         0         0         0    S  120   0.0   0.0   0.0
```

В данном примере виртуальная машина имеет 11 потоков, включая vCPU, vnc\_worker и IO mon\_iotreads. Каждый поток также отображает подробную информацию о загрузке ресурсов процессора и trap-сообщениях.

2. Выберите элемент мониторинга. Введите f для его редактирования.

```sh
field filter - select which field to be showed
Use up/down to navigate, use space to set whether chosen filed to be showed
'q' to quit to normal display

 * DID
 * VM/task-name
 * PID
 * %CPU
 * EXThvc
 * EXTwfe
 * EXTwfi
 * EXTmmioU
 * EXTmmioK
 * EXTfp
 * EXTirq
 * EXTsys64
 * EXTmabt
 * EXTsum
 * S
 * P
 * %ST
 * %GUE
 * %HYP
```

По умолчанию выводятся все элементы мониторинга. Выбрать элемент мониторинга можно нажатием клавиш вверх или вниз. Нажмите пробел для установки элемента мониторинга и нажмите q, чтобы выйти. После скрытия элементов %ST, %GUE и %HYP отображается следующая информация:

```sh
vmtop - 2020-09-14 10:23:25 - 1.0
Domains: 1 running

  DID  VM/task-name     PID  %CPU    EXThvc    EXTwfe    EXTwfi  EXTmmioU  EXTmmioK     EXTfp    EXTirq  EXTsys64   EXTmabt    EXTsum    S    P
    2       example 4054916  12.0         0         0      1213        14         1       144        68       168         0      1464    S  125
   |_    qemu-kvm 4054916   0.0         0         0         0         0         0         0         0         0         0         0    S  125
   |_    qemu-kvm 4054928   0.0         0         0         0         0         0         0         0         0         0         0    S  119
   |_  signalfd_com 4054929   0.0         0         0         0         0         0         0         0         0         0         0    S  120
   |_  IO mon_iothr 4054932   0.0         0         0         0         0         0         0         0         0         0         0    S  117
   |_     CPU 0/KVM 4054933   2.0         0         0       303         6         0        29        10        35         0       354    S   98
   |_     CPU 1/KVM 4054934   4.0         0         0       279         0         0        39        17        49         0       345    S    1
   |_     CPU 2/KVM 4054935   3.0         0         0       283         0         0        33        20        40         0       343    S  122
   |_     CPU 3/KVM 4054936   3.0         0         0       348         8         1        43        21        44         0       422    S  110
   |_   memory_lock 4054940   0.0         0         0         0         0         0         0         0         0         0         0    S  126
   |_    vnc_worker 4054944   0.0         0         0         0         0         0         0         0         0         0         0    S  118
   |_        worker    1794   0.0         0         0         0         0         0         0         0         0         0         0    S  126
```

Элементы %ST, %GUE и %HYP не будут отображаться на экране.