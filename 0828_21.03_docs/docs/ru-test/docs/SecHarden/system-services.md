# Системные службы

- [Системные службы](#system-services)
  - [Усиление безопасности службы SSH](#hardening-the-ssh-service)

## Усиление безопасности службы SSH

### Описание

Secure Shell (SSH) — это надежный протокол для безопасного удаленного входа и работы других сетевых служб. SSH не допускает раскрытия информации во время удаленного сеанса управления. SSH шифрует передаваемые данные, предотвращая попытки злоумышленного изменения данных кэша доменных имен (DNS spoofing ) и подмены IP-адреса источника (IP spoofing). В качестве альтернативы патентованному протоколу SSH был создан OpenSSH с открытым исходным кодом.

Мера усиления безопасности службы SSH заключается в изменении ее конфигурации с установкой алгоритма и параметров аутентификации при использовании системой протокола OpenSSH. В [Табл. 1](#en-us_topic_0152100390_ta2fdb8e4931b4c1a8f502b3c7d887b95) приведены параметры усиления безопасности, рекомендуемые значения и политики по умолчанию.

### Реализация

Для усиления безопасности сервера выполните следующие действия:

1. Откройте на сервере конфигурационный файл **/etc/ssh/sshd\_config** службы SSH и измените значения параметров усиления безопасности или добавьте эти параметры в файл.

2. Сохраните файл **/etc/ssh/sshd\_config**.

3. Перезапустите службу SSH следующей командой:
   
   ```
   systemctl restart sshd
   ```

  

Для усиления безопасности клиента выполните следующие действия:

1. Откройте на клиенте конфигурационный файл **/etc/ssh/ssh\_config** службы SSH и измените значения параметров усиления безопасности или добавьте эти параметры в файл.

2. Сохраните файл **/etc/ssh/ssh\_config**.

3. Перезапустите службу SSH следующей командой:
   
   ```
   systemctl restart sshd
   ```

### Параметры усиления безопасности

- Политики усиления безопасности сервера
  
  Все параметры усиления безопасности службы SSH хранятся в конфигурационном файле **/etc/ssh/sshd\_config**. Подробная информация о параметрах усиления безопасности сервера, рекомендациях и сконфигурированы или нет данные параметры в соответствии с рекомендациями, приведена в [Табл. 1](#en-us_topic_0152100390_ta2fdb8e4931b4c1a8f502b3c7d887b95).
  
  **Табл. 1** Параметры усиления безопасности службы SSH на сервере
  
  | **Параметр**                                    | Описание                                                     | **Рекомендация**                                             | **Сконфигурировано в соответствии с рекомендацией** |
  | ----------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | --------------------------------------------------- |
  | Protocol                                        | Версия протокола SSH.                                        | 2                                                            | Да                                                  |
  | SyslogFacility                                  | Тип журнала службы SSH. Значение **AUTH** указывает на журналы аутентификации. | AUTH                                                         | Да                                                  |
  | LogLevel                                        | Уровень записи журналов SSHD.                                | VERBOSE                                                      | Да                                                  |
  | X11Forwarding                                   | Параметр определяет, можно или нельзя использовать GUI после входа в систему с помощью SSH. | no                                                           | Да                                                  |
  | MaxAuthTries                                    | Максимальное количество попыток аутентификации.              | 3                                                            | Нет                                                 |
  | PubkeyAuthentication                            | Параметр устанавливает разрешение на метод аутентификации с помощью открытого ключа. | yes                                                          | Да                                                  |
  | RSAAuthentication                               | Параметр устанавливает разрешение только на метод аутентификации по алгоритму RSA. | yes                                                          | Да                                                  |
  | IgnoreRhosts                                    | Параметр определяет использование файлов **rhosts** и **shosts** для аутентификации. В файлы **rhosts** и **shosts** записываются имена серверов, поддерживающих удаленный доступ, и связанные с ним имена логинов. | yes                                                          | Да                                                  |
  | RhostsRSAAuthentication                         | Параметр определяет использование аутентификации по алгоритму RSA на основе файла **rhosts**. В файл **rhosts** записываются имена серверов, поддерживающих удаленный доступ, и связанные с ним имена  логинов. | no                                                           | Да                                                  |
  | HostbasedAuthentication                         | Параметр определяет использование метода аутентификации на основе хоста. Данный метод аутентификации означает, что любой пользователь доверенного клиента может использовать службу SSH. | no                                                           | Да                                                  |
  | PermitRootLogin                                 | Параметр устанавливает разрешение на вход пользователя **root** в систему с помощью службы SSH. ПРИМЕЧАНИЕ: если вход в систему пользователя **root** с помощью SSH необходим, установите в поле **PermitRootLogin** в файле **/etc/ssh/sshd_config** значение **yes**. | no                                                           | Нет                                                 |
  | PermitEmptyPasswords                            | Параметр устанавливает разрешение на доступ в систему учетных записей с пустыми паролями. | no                                                           | Да                                                  |
  | PermitUserEnvironment                           | Параметр определяет, будут ли разрешены переменные среды, установленные в **~/.ssh/environment** и **~/.ssh/authorized_keys**. | no                                                           | Да                                                  |
  | Ciphers                                         | Алгоритм шифрования передачи данных SSH.                     | aes128-ctr,aes192-ctr,aes256-ctr,chacha20-poly1305@openssh.com,aes128-gcm@openssh.com,aes256-gcm@openssh.com | Да                                                  |
  | ClientAliveCountMax                             | Количество таймаутов. При достижении количества неответов клиента на отправленный сервером запрос определенного значения сервер автоматически отключается от клиента. | 0                                                            | Нет                                                 |
  | Banner                                          | Файл с текстом приглашения, которое появляется до и после входа в SSH. | /etc/issue.net                                               | Да                                                  |
  | MACs                                            | Алгоритм хеширования для проверки данных SSH.                | hmac-sha2-512,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-256-etm@openssh.com, hmac-sha1,hmac-sha1-etm@openssh.com | Да                                                  |
  | StrictModes                                     | Параметр устанавливает проверку разрешения на доступ к домашнему каталогу и файлу **rhosts** и их владельцев перед получением запроса на вход в службу SSH. | yes                                                          | Да                                                  |
  | UsePAM                                          | Параметр определяет использование PAM для аутентификации пользователя при входе в систему. | yes                                                          | Да                                                  |
  | AllowTcpForwarding                              | Параметр устанавливает разрешение на переадресацию TCP.      | no                                                           | Да                                                  |
  | Subsystem sftp /usr/libexec/openssh/sftp-server | Уровень записи журнала SFTP, который записывает уровень INFO и журналы аутентификации. | -l INFO -f AUTH                                              | Да                                                  |
  | AllowAgentForwarding                            | Параметр устанавливает разрешение на переадресацию SSH Agent. | no                                                           | Да                                                  |
  | GatewayPorts                                    | Параметр определяет возможность подключения службы SSH к портам клиента переадресации. | no                                                           | Да                                                  |
  | PermitTunnel                                    | Параметр допускает туннельные устройства.                    | no                                                           | Да                                                  |
  | KexAlgorithms                                   | Алгоритмы обмена ключами SSH.                                | curve25519-sha256,curve25519-sha256@@libssh.org,diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group-exchange-sha256 | Да                                                  |
  | LoginGraceTime                                  | Ограничение на время прохождения пользователями процедуры аутентификации. **0** означает отсутствие ограничений. Значение по умолчанию — **60** секунд. | 60                                                           | Нет                                                 |
  
  > ![](./public_sys-resources/icon-note.gif) ПРИМЕЧАНИЕ:  
  По умолчанию сообщения, отображаемые до и после входа в SSH, сохраняются в файл **/etc/issue.net**. В файле **/etc/issue.net** по умолчанию настроена конфигурация **Authorized users only.** **All activities may be monitored and reported.**
  
- Политики усиления безопасности на клиенте
  
  Все параметры усиления безопасности службы SSH хранятся в конфигурационном файле **/etc/ssh/ssh\_config**. Подробная информация о параметрах усиления безопасности клиента, рекомендациях и сконфигурированы или нет данные параметры в соответствии с рекомендациями, приведена в [Табл. 2](#en-us_topic_0152100390_tb289c5a6f1c7420ab4339187f9018ea4).
  
  **Табл. 2** Параметры усиления безопасности службы SSH на клиенте
  
  | Параметр         | **Описание**                                                 | **Рекомендация**                                             | **Сконфигурировано в соответствии с рекомендацией** |
  | ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | --------------------------------------------------- |
  | KexAlgorithms    | Алгоритмы обмена ключами  SSH.                               | ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1 | Нет                                                 |
  | VerifyHostKeyDNS | Параметр определяет метод верификации файлов HostKey — с помощью DNS или SSHFP. | ask                                                          | Нет                                                 |
  
  > ![](./public_sys-resources/icon-note.gif) ПРИМЕЧАНИЕ:  
  Чтобы реализовать соединение с ключом как минимум 2048 бит, требуются сторонние клиенты и серверы, которые используют алгоритм Diffie-Hellman.

### Другие рекомендации по мерам безопасности

- Служба SSH прослушивает только на указанных IP-адресах.
  
  Для целей безопасности при использовании службы SSH рекомендуется прослушивание только на указанных IP-адресах, а не на 0.0.0.0. IP-адреса, которые будет прослушивать служба SSH, указываются в конфигурационном параметре ListenAddress в файле **/etc/ssh/sshd\_config**.
  
  1. Откройте и сохраните файл **/etc/ssh/sshd\_config**.
     
     ```
     vi /etc/ssh/sshd_config
     ```
     
     Следующая информация указывает на то, что привязанным IP-адресом прослушивания является **192.168.1.100**. IP-адрес прослушивания можно изменить в соответствии с требованиями площадки.
     
     ```
     ...
     ListenAddress 192.168.1.100
     ...
     ```
  
  2. Перезапустите службу SSH.
     
     ```
     systemctl restart sshd.service
     ```

- Пользователям SFTP ограничен доступ к каталогам верхнего уровня.
  
  SFTP (SSH File Transfer Protocol) — это протокол прикладного уровня, предназначенный для передачи файлов поверх безопасного соединения SSH. Для загрузки и выгрузки файлов пользователи вместо входа в службу SSH могут войти в SFTP, используя специально выделенные учетные записи. Через SFTP можно получить доступ не ко всем каталогам. Эта мера предотвращает атаки с обходом каталогов (directory traversal attack). Процесс настройки:
  
  > ![](./public_sys-resources/icon-note.gif) ПРИМЕЧАНИЕ:  
В следующих конфигурациях **sftpgroup** — это взятое для примера имя группы пользователей, а **sftpuser** — имя пользователя.
  
  1. Создайте группу пользователей SFTP.
     
     ```
     groupadd sftpgroup
     ```
  
  2. Создайте корневой каталог SFTP.
     
     ```
     mkdir /sftp
     ```
  
  3. Измените владельца корневого каталога SFTP и разрешение на доступ к нему.
     
     ```
     chown root:root /sftp
     chmod 755 /sftp
     ```
  
  4. Создайте пользователя SFTP.
     
     ```
     useradd -g sftpgroup -s /sbin/nologin sftpuser
     ```
  
  5. Установите пароль пользователя SFTP.
     
     ```
     passwd sftpuser
     ```
  
  6. Создайте каталог, который будет использоваться для хранения файлов, загруженных пользователем SFTP.
     
     ```
     mkdir /sftp/sftpuser
     ```
  
  7. Измените владельца каталога выгрузки пользователя SFTP и разрешение на доступ к нему.
     
     ```
     chown root:root /sftp/sftpuser
     chmod 777 /sftp/sftpuser
     ```
  
  8. Измените файл **/etc/ssh/sshd\_config**.
     
     ```
     vi /etc/ssh/sshd_config
     ```
     
     Измените следующую информацию:
     
     ```
     #Subsystem sftp /usr/libexec/openssh/sftp-server -l INFO -f AUTH
     Subsystem sftp internal-sftp -l INFO -f AUTH
     ...
     
     Match Group sftpgroup                  
         ChrootDirectory /sftp/%u
         ForceCommand internal-sftp
     ```
     
     > ![](./public_sys-resources/icon-note.gif) ПРИМЕЧАНИЕ:
     > 
     > - **%u** — это подстановочный символ. Введите **%u** для представления имени текущего пользователя SFTP.
     > - В конце файла **/etc/ssh/sshd\_config** необходимо добавить следующее содержимое:
     > 
     > ```
     >   Match Group sftpgroup                    
     >     ChrootDirectory /sftp/%u  
     >     ForceCommand internal-sftp  
     > ```
  
  9. Перезапустите службу SSH.
     
     ```
     systemctl restart sshd.service
     ```

- Удаленное выполнение команд с помощью SSH.
  
  Когда команда выполняется удаленно через OpenSSH, TTY по умолчанию отключен. Если во время выполнения команды требуется пароль, он отображается открытым текстом. Чтобы обеспечить безопасность ввода пароля, рекомендуется добавить в команду опцию **-t**. Пример.
  
  ```
  ssh -t testuser@192.168.1.100 su
  ```
  
  > ![](./public_sys-resources/icon-note.gif) ПРИМЕЧАНИЕ:  
**192.168.1.100** — IP-адрес, а **testuser** — имя пользователя.