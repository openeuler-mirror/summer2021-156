# Запуск контейнера с помощью systemd

- [Запуск контейнера с помощью systemd](#using-systemd-to-start-a-container)

## Описание функционала

Процесс init, запускаемый в системных контейнерах, отличается от процессов init в обычных контейнерах. Обычные контейнеры не могут запускать системные службы через systemd. Однако системные контейнеры имеют эту возможность. Служба systemd включается заданием параметра 
**--system-contianer** при запуске системного контейнера.

## Описание параметров

| **Команда**      | **Параметр**       | **Описание значений**                                        |
| ---------------- | ------------------ | ------------------------------------------------------------ |
| isula create/run | --system-container | ·   Это значение логического типа **true** или **false**. Значение по умолчанию — **true**.<br />·  Определяет, является ли контейнер системным контейнером. Данную функцию необходимо включить. |

## Ограничения

- Служба systemd должна вызывать ряд специальных системных API, включая mount, umount2, unshare, reboot и name\_to\_handle\_at. Поэтому разрешения на вызов вышеуказанных API включаются для системных контейнеров, когда тег привилегированного контейнера отключен.
- Все системные контейнеры запускаются процессом init. Данный процесс не отвечает на сигнал SIGTERM, который указывает на корректное завершение. По умолчанию команда **stop** принудительно останавливает контейнер через 10 секунд. Если требуется более быстрая остановка, вручную задайте период ожидания команды **stop**.
- **--system-container** используется вместе с **--external-rootfs**.
- В системном контейнере могут работать различные службы. Команда **systemctl** используется для управления запуском и остановкой служб. Службы могут зависеть друг от друга. В результате, при возникновении ошибки некоторые служебные процессы переходят в состояние D или Z, поэтому контейнер не может корректно завершить работу.
- Некоторые служебные процессы в системном контейнере могут влиять на результаты других операций. Например, если в контейнере работает служба NetworkManager, это может повлиять на операцию добавления карт NIC в контейнер (возможно, что карты NIC будут успешно добавлены, но затем остановлены службой NetworkManger), что может привести к непредвиденным результатам.
- В настоящее время системные контейнеры и хосты нельзя изолировать с помощью событий udev. Поэтому нельзя сконфигурировать файл **fstab**.
- Служба systemd может конфликтовать со службой cgconfig, предоставляемой libcgroup. Рекомендуется удалить из контейнера пакеты, связанные с libcgroup, или установить параметру **Delegate** службы cgconfig значение **no**.

## Пример

- Для запуска системного контейнера укажите параметры **--system-container** и **--external-rootfs**.
  
  ```
  [root@localhost ~]# isula run -tid -n systest01 --system-container --external-rootfs /root/myrootfs none init
  ```

- После выполнения вышеуказанных команд контейнер корректно работает. Командой **exec** можно получить доступ к контейнеру и просмотреть информацию о процессе. В командном выводе содержится информация, что служба systemd запущена.
  
  ```
  [root@localhost ~]# isula exec -it systest01 bash
  [root@localhost /]# ps -ef
  UID        PID  PPID  C STIME TTY          TIME CMD
  root         1     0  2 06:49 ?        00:00:00 init
  root        14     1  2 06:49 ?        00:00:00 /usr/lib/systemd/systemd-journal
  root        16     1  0 06:49 ?        00:00:00 /usr/lib/systemd/systemd-network
  dbus        23     1  0 06:49 ?        00:00:00 /usr/bin/dbus-daemon --system --
  root        25     0  0 06:49 ?        00:00:00 bash
  root        59    25  0 06:49 ?        00:00:00 ps –ef
  ```

- Выполните команду **systemctl** в контейнере, чтобы проверить статус службы. В командном выводе содержится информация, что данная служба управляется службой systemd.
  
  ```
  [root@localhost /]# systemctl status dbus
  ● dbus.service - D-Bus System Message Bus
     Loaded: loaded (/usr/lib/systemd/system/dbus.service; static; vendor preset:
  disabled)
     Active: active (running) since Mon 2019-07-22 06:49:38 UTC; 2min 5
  8s ago
       Docs: man:dbus-daemon(1)
   Main PID: 23 (dbus-daemon)
     CGroup: /system.slice/dbus.service
             └─23 /usr/bin/dbus-daemon --system --address=systemd: --nofork --nopidf
  ile --systemd-activation --syslog-only
  
  Jul 22 06:49:38 localhost systemd[1]: Started D-Bus System Message Bus.
  ```

- Выполните команду **systemctl** в контейнере, чтобы остановить или запустить службу. В командном выводе содержится информация, что данная служба управляется службой systemd.
  
  ```
  [root@localhost /]# systemctl stop dbus
  Warning: Stopping dbus.service, but it can still be activated by:
    dbus.socket
  [root@localhost /]# systemctl start dbus
  ```