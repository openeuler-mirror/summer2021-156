# Управление образами

- [Управление образами](#image-management-1)
  - [Создание образа](#creating-an-image)
  - [Просмотр образов](#viewing-images)
  - [Удаление образов](#deleting-images)

## Создание образа

Для создания образа используется команда **docker pull**, **docker build**, **docker commit**, **docker import** или **docker load**. Подробная информация об использовании этих команд приведена в разделе [4.6.3 Управление образами.](#image-management-43.md#EN-US_TOPIC_0184808261)

### Меры предосторожности

1. Не выполняйте одновременно команды **docker load** и **docker rmi**. При выполнении двух следующих условий могут возникнуть проблемы с параллельным выполнением операций:
   
   - В системе существует образ.
   - В отношении данного образа одновременно выполняются операции **docker load** и **docker rmi**.
   
   Поэтому следует избегать этого сценария. (Все операции, выполняемые параллельно операциям создания образа, например **ag**, **build**, **load**, **rmi**, могут стать причиной возникновения подобных ошибок. Поэтому не выполняйте эти операции одновременно с командами **rmi**.)

2. Если систему отключить от сети питания в момент выполнения операций контейнером Docker с образом, возможно повреждение данного образа. В этом случае необходимо будет вручную выполнить операции восстановления образа.
   
   Когда Docker выполняет операции с образом (используя команды **pull**, **load**, **rmi**, **build**, **combine**, **commit**, **import**), операции с данными образа являются асинхронными, а с метаданными образа — синхронными. Поэтому, если отключить питание системы в момент, когда еще не все данные образа обновились на диске, возможно, что эти данные не будут согласованы с метаданными. Пользователи смогут просматривать образы (возможно, промежуточные образы или none-образы), но не смогут запускать контейнеры, или же на запущенных контейнерах возникнет ошибка. В этом случае выполните команду **docker rmi**, чтобы удалить образ, и повторите выполнение предыдущих операций. Таким образом, система восстановится.

3. Не храните большое количество образов на узлах в рабочей среде. Своевременно удаляйте ненужные образы.
   
   При большом числе хранящихся образов замедляется скорость выполнения таких команд, как **docker image**. В результате, происходит ошибка выполнения таких команд, как **docker build** и **docker commit**, и данная область памяти может стать стековой. В рабочей среде своевременно удаляйте ненужные образы и образы промежуточных процессов.

4. Если для создания образа используется параметр **--no-parent** и одновременно выполняются несколько операций по сборке, а образы FROM в Dockerfile одинаковые, может остаться часть образов. Два варианта настройки:
   
   - Если образы FROM неполные, то могут остаться образы, сгенерированные во время работы образов FROM. Имена оставшихся образов подобны **base\_v1.0.0-app\_v2.0.0**, или они являются промежуточными образами.
   - Если первые несколько инструкций в Dockerfile одинаковы, возможно, остались промежуточные образы.

### Условия, которые могут привести к генерации none-образов

1. Промежуточный образ (или none-образ) — это образ верхнего уровня без тега. Например, идентификатор образа **ubuntu** имеет только один тег **ubuntu**. Если тег не используется, но идентификатор образа все еще доступен, такой образ становится промежуточным.
2. Любой образ имеет защиту, поскольку данные образа необходимо экспортировать во время его сохранения. Однако, возможно, что при выполнении операции удаления тег образа будет успешно удален, а идентификатор образа не будет удален (потому что образ защищен). В результате образ становится промежуточным.
3. Создание промежуточного образа возможно, если при выполнении команды **docker pull** отключить питание системы, или в системе в этот момент возникнет критическая ошибка (паника). Чтобы обеспечить целостность образа, можно удалить его командой **docker rmi**, а затем перезапустить.
4. Если при выполнении команды **docker save** для сохранения образа будет указан идентификатор в качестве имени образа, образ будет загружен без тега, а именем образа будет **none**.

### Небольшая вероятность сбоя создания образа в случае его удаления в момент создания

В настоящее время процесс создания образа защищен методом подсчета числа ссылок. После создания образа число ссылок образа увеличивается на 1 (операция удержания). После успешной операции удержания образ не удаляется. Однако существует небольшая вероятность удаления образа до операции удержания, что приводит к сбою его создания.

## Просмотр образов

Просмотр списка локальных образов осуществляется следующей командой:

```
docker images
```

## Удаление образов

### Меры предосторожности

Не удаляйте образ командой **docker rmi -f** *XXX*. При принудительном удалении образа команда **docker rmi** игнорирует ошибки, возникающие во время выполнения процесса, что может стать причиной остаточных метаданных образа. Если ошибка возникает во время удаления образа в обычном режиме, удаление не выполняется, и метаданные не остаются.