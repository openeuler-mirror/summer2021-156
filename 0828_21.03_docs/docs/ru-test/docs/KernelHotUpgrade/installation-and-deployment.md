# Установка и развертывание

В данном документе приведено описание установки и развертывания инструмента динамического обновления ядра.

<!-- TOC -->
- [Установка и развертывание](#installation-and-deployment)
  - [Требования к аппаратному и программному обеспечению](#hardware-and-software-requirements)
    - [Требования к аппаратному обеспечению](#hardware-requirements)
    - [Требования к программному обеспечению](#software-requirements)
  - [Подготовка среды](#environment-preparation)
  - [Установка инструмента динамического обновления ядра](#installing-the-kernel-hot-upgrade-tool)
  - [Развертывание инструмента динамического обновления ядра](#deploying-the-kernel-hot-upgrade-tool)
    - [Конфигурации](#configurations)
  - [Включение инструмента динамического обновления ядра](#enabling-the-kernel-hot-upgrade-tool)

<!-- /TOC -->

## Требования к аппаратному и программному обеспечению

### Требования к аппаратному обеспечению

- В данный момент поддерживается только архитектура ARM64.

### Требования к программному обеспечению

- Операционная система: openEuler 21.03

## Подготовка среды

- Установите систему openEuler. Подробная информация приведена в документе *Руководство по установке openEuler 21.03*.

- Для установки инструмента динамического обновления ядра требуется разрешение root.

## Установка инструмента динамического обновления ядра

В данном разделе описывается процесс установки инструмента динамического обновления ядра.

Выполните следующие действия:

1. Монтируйте ISO-файл openEuler.
   
   ```
   # mount openEuler-21.03-aarch64-dvd.iso /mnt
   ```

2. Настройте локальный репозиторий yum.
   
   ```
   # vim /etc/yum.repos.d/local.repo
   ```
   
   Ниже приведены конфигурации.
   
   ```
   [local]
   name=local
   baseurl=file:///mnt
   gpgcheck=1
   enabled=1
   ```

3. Импортируйте в систему открытый ключ GPG цифровой подписи RPM.
   
   ```
   # rpm --import /mnt/RPM-GPG-KEY-openEuler
   ```

4. Установите инструмент динамического обновления ядра.
   
   ```
   # yum install nvwa -y
   ```

5. Убедитесь, что установка выполнена. Установка считается успешно выполненной, если на экране появляется приведенная информация.
   
   ```
   # rpm -qa | grep nvwa
   nvwa-xxx
   ```

## Развертывание инструмента динамического обновления ядра

В данном разделе описывается способ развертывания инструмента динамического обновления ядра.

### Обзор

Конфигурационные файлы инструмента динамического обновления ядра хранятся в /etc/nvwa. Ниже приведены конфигурационные файлы.

- nvwa-restore.yaml
  
  Этот конфигурационный файл используется для сохранения и восстановления процесса во время динамического обновления ядра с помощью данного инструмента. Параметры конфигурации выглядят следующим образом:
  
  + pids
    
    Указывает процессы, которые необходимо сохранить и восстанавливать во время динамического обновления NVWA. Процессы определяются по идентификатору процесса (PID). Следует отметить, что процессы, управляемые NVWA, автоматически восстанавливаются после запуска службы NVWA.
  
  + services
    
    Указывает сервисы, которые необходимо сохранить и восстанавливать во время динамического обновления NVWA. По сравнению с PID, инструмент динамического обновления ядра может непосредственно сохранить и восстановить процесс. Для сервисов инструмент динамического обновления ядра использует systemd для выполнения соответствующих операций. Это имя сервиса должно быть таким же, как имя сервиса, используемое в systemd. Следует отметить, что необходимость автоматического восстановления сервиса, управляемого NVWA, при запуске NVWA зависит от того, включен ли этот сервис в systemd. В данный момент поддерживаются только типы сервиса notify и oneshot.
  
  + restore\_net
    
    Определяет, требуется ли инструмент динамического обновления ядра для сохранения и восстановления сетевой конфигурации. Если сетевая конфигурация некорректна, может возникнуть ошибка в работе сети после восстановления. Функция отключена по умолчанию.
  
  + enable\_quick\_kexec
    
    Определяет, требуется ли включение функции quick kexec, которая выпущена сообществом NVWA для ускорения процесса перезапуска ядра. Для использования этой функции добавьте «quickkexec=128M» в командную строку. В этом примере 128 указывает на размер памяти, выделенной для функции quick kexec. Выделенная память используется для загрузки ядра и initramfs во время обновления. Поэтому размер должен быть больше, чем общий размер ядра и initramfs, вовлеченных в обновлении. Функция отключена по умолчанию.
  
  + enable\_pin\_memory
    
    Определяет, требуется ли включение функции pin memory, которая выпущена сообществом NVWA для ускорения сохранения и восстановления процесса. Для использования этой функции добавьте «max\_pin\_pid\_num=10 redirect\_space\_size=2M pinmemory=200M@0x640000000» в командную строку.
    
    max\_pin\_pid\_num указывает на максимальное количество процессов, поддерживающих восстановление pin memory. rredirect\_space\_size указывает на зарезервированное пространство памяти, необходимое для перенаправления физических страниц во время восстановления pin memory. Рекомендуется установить для параметра redirect\_space\_size значение 1/100 от общего зарезервированного пространства pin memory. pinmemory указывает начальную точку и размер сегмента памяти. Пространство емкостью 200 МБ, начинающееся с 0x640000000, — это общее пространство памяти, используемое pin memory. Это пространство памяти не должно использоваться другими программами.

- Пример конфигурации nvwa-restore.yaml

```
pids:
  - 14109
services:
  - redis
restore_net: false
enable_quick_kexec: true
enable_pin_memory: true
```

- nvwa-server.yaml
  
  В этом файле содержится информация о конфигурации, необходимая во время работы инструмента динамического обновления ядра. Ниже приводится подробная информация.
  
  + criu\_dir
    
    Этот параметр указывает каталог для хранения данных, создаваемых при запуске инструмента динамического обновления ядра. Следует учитывать, что такая информация может занимать большой объем дискового пространства.
  
  + criu\_exe
    
    Этот параметр указывает путь к исполняемому файлу CRIU, используемому инструментом динамического обновления ядра. Рекомендуем вам не изменять путь за исключением случаев, когда вам необходимо отладить CRIU.
  
  + kexec\_exe
    
    Этот параметр указывает путь к исполняемому файлу kexec, используемому инструментом динамического обновления ядра. Рекомендуем вам не изменять путь за исключением случаев, когда вам необходимо отладить kexec.
  
  + systemd\_etc
    
    Этот параметр указывает путь к папке, используемой для перезаписи конфигурационного файла systemd. Путь определяется systemd. Обычно вам не нужно его менять.
  
  + log\_dir
    
    Этот параметр используется для хранения информации о журналах, сгенерированной инструментом динамического обновления ядра. В данный момент модуль журнала не активирован. Для получения более подробной информации о просмотре журналов инструмента динамического обновления ядра см. в разделе How to Run.

- Пример конфигурации nvwa-server.yaml

```
criu_dir: /var/nvwa/running/
criu_exe: /usr/sbin/criu
kexec_exe: /usr/sbin/kexec
systemd_etc: /etc/systemd/system/
log_dir: /etc/nvwa/log/
```

## Включение инструмента динамического обновления ядра

Работа инструмента динамического обновления ядра зависит от конфигурационного файла. После изменения конфигурационного файла необходимо снова запустить этот инструмент.

После успешной установки вы можете запустить команды systemd для управления инструментом динамического обновления ядра.

+ Включите NVWA.
  
  systemctl enable nvwa

+ Запустите NVWA.
  
  systemctl start nvwa

+ Просмотрите журнал NVWA.
  
  service nvwa status

+ Для получения более подробной информации см. метод использования systemd.