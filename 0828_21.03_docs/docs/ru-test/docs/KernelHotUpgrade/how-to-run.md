# Способ использования

<!-- TOC -->
- [Способ использования](#how-to-run)
  - [Команда](#command)
  - [Ограничение использования](#use-restriction)
  - [Описание и применение функции ускорения NVWA](#nvwa-acceleration-feature-description-and-use)
  - [Информация о сгенерированных журналах](#generated-log-information)

<!-- /TOC -->

## Команда

+ nvwa help
  
  Команда используется для отображения нижеприведенной справочной информации.
  
  ```
  NAME:
  nvwa - a tool used for openEuler kernel update.
  
  USAGE:
  nvwa [global options] command [command options] [arguments...]
  
  VERSION:
  0.1
  
  COMMANDS:
  update   specify kernel version for nvwa to update
  init     init nvwa running environment
  help, h  Shows a list of commands or help for one command
  
  GLOBAL OPTIONS:
  --help, -h     show help (default: false)
  --version, -v  print the version (default: false)
  ```

+ nvwa update <kernel version>
  
  Когда происходит динамическое обновление ядра до нужной версии, NVWA ищет образ ядра и ramfs в каталоге /boot. Ядро должно быть названо в формате vmlinuz-<kernel version>, а rootfs — в формате initramfs-<kernel version>.img.
  
  Важно отметить, что в процессе обновления может произойти ошибка. В случае сбоя обновления некоторые выгруженные процессы или сервисы перестанут работать.

+ nvwa init
  
  Команда используется для удаления информации о запуске, сгенерированной NVWA, и изменения конфигурации systemd. С помощью ее также можно удалить информацию о работе перед выполнением или после неудачного выполнения NVWA.

## Ограничение использования

1. Для сервисов, которые должны сохраняться с помощью NVWA, необходимо установить StandardOutput и StandardError в конфигурации. Ниже в качестве примера используется Redis.
   
   ```
   [Unit]
   Description=Redis persistent key-value database
   After=network.target
   [Service]
   ExecStart=/usr/bin/redis-server /etc/redis.conf --supervised systemd
   Type=notify
   User=redis
   Group=redis
   RuntimeDirectory=redis
   RuntimeDirectoryMode=0755
   StandardOutput=file:/root/log1.log
   StandardError=file:/root/log2.log
   [Install]
   WantedBy=multi-user.target
   ```

2. Для использования функции ускорения необходимо изменить командную строку и выделить необходимую память. Для получения подробной информации нажмите [здесь](# Описание и применение функции ускорения NVWA).

3. SELINUX необходимо отключить во время запуска.
   
   Теоретически, отключить сервис NVWA нужно только после выполнения команды **NVWA update** и перед перезагрузкой системы для восстановления процесса. Рекомендуется отключить SELinux во время всего процесса.

## Описание и применение функции ускорения NVWA

1. cpu park
   
   Команда cpu park использует процесс kexec для того, чтобы заставить процессор быть в активном ожидании. Это позволит быстрее реагировать на запрос прерывания, посылаемый основным ядром, и уменьшить изменения состояния.
   
   Для использования этой команды необходимо добавить «cpuparkmem=0x200000000» в командную строку. 0x200000000 — это начальный адрес памяти, который не используется другими программами. cpuparkmem занимает пространство памяти размером около 1 МБ от этого адреса.
   
   Обратите внимание, что если памяти достаточно, рекомендуется использовать диапазон адресов после 4G(0x100000000). Первые 4 ГБ обычно резервируются разным компонентом системы, что может вызвать конфликт.

2. quick kexec
   
   Команда ускоряет загрузку изображений с помощью kexec.
   
   Чтобы использовать команду quick kexec, необходимо включить соответствующие параметры в конфигурационном файле. Для получения дополнительной информации см. раздел «Конфигурация» в документе Установка и развертывание.

3. pin\_memory
   
   С помощью этой команды ускоряется хранение и восстановление CRIU.
   
   Чтобы использовать команду pin memory, необходимо включить соответствующие параметры в конфигурационном файле. Для получения дополнительной информации см. раздел «Конфигурация» в документе Установка и развертывание.

## Информация о сгенерированных журналах

Журналы, сгенерированные инструментом динамического обновления ядра, состоят из двух частей:

+ Журналы, сгенерированные во время работы
  
  Запустите команду service nvwa status для просмотра журналов.

+ Журналы, сгенерированные при сохранении информации о работе
  
  Журналы хранятся в папке процесса/сервиса по пути, указанному criu\_dir.