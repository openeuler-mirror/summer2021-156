# Использование инструментов secGear

secGear предоставляет набор инструментов для облегчения разработки приложений. В данном документе приведено описание инструментов и способов их использования.

## Codegener: Code Generation Tool — Инструмент для создания кода

### Краткое описание

secGear codegener — это инструмент, разработанный на основе Intel SGX SDK edger8r. Он используется для анализа EDL-файла с целью генерации промежуточного C-кода. То есть, он помогает в создании кода, который будет вызван между TEE и REE.

Формат EDL-файла, определенный secGear codegener, совпадает с форматом, определенным Intel SGX SDK edger8r, но полное определение синтаксиса Intel не поддерживается.

- public можно использовать только в методах. Функции без public по умолчанию объявляются как private.
- Вызовы без переключения (Switchless calls) с REE на TEE и с TEE на REE не поддерживаются.
- Внешний вызов (Outside Call; OCALL) не поддерживает некоторые режимы вызова (например, cdecl, stdcall и fastcall).

Синтаксис EDL-файла похож на синтаксис языка программирования C. Ниже приведены отличия от синтаксиса языка программирования C.

| Элемент             | Описание                                                     |
| ------------------- | ------------------------------------------------------------ |
| include "my_type.h” | Использование типа, определенного во внешнем файле включений. |
| trusted             | Объявление о доступности защищенных функций на стороне доверенного приложения (TA). |
| untrusted           | Объявление о доступности небезопасных функций на стороне TA. |
| return_type         | Определение типа возвращаемого значения.                     |
| parameter_type      | Определение типа параметра.                                  |
| [in, size = len]    | Для ECALL данный параметр указывает на необходимость передачи данных от REE к TEE. В случае OCALL данный параметр должен использоваться для типа указателя, а size указывает на буфер, который фактически используется. |
| [out, size = len]   | Для ECALL данный параметр указывает на необходимость передачи данных от TEE к REE. В случае OCALL данный параметр должен использоваться для типа указателя, а size указывает на буфер, который фактически используется. |

### Инструкции по использованию

#### **Формат команды**

Формат команды codegen:

- Архитектура x86\_64:

**codegen\_x86\_64** \< --trustzone \| --sgx > \[--trusted-dir <path> \| **--untrusted-dir** <path>\| --trusted \| --untrusted ]  edlfile

Архитектура ARM

**codegen\_arm64** \< --trustzone \| --sgx > \[--trusted-dir <path> \| **--untrusted-dir** <path>\| --trusted \| --untrusted ]  edlfile

#### **Описание параметра**

Ниже приведено описание параметров.

| **Параметр**           | Обязательно/Опционально | Описание                                                     |
| ---------------------- | ----------------------- | ------------------------------------------------------------ |
| --trustzone \| --sgx   | Обязательно             | Генерирует функцию API, соответствующую архитектуре конфиденциальных вычислений, только в текущем каталоге команд. Если ни один параметр не указан, по умолчанию генерируется функция SGX API. |
| --search-path <path>   | Опционально             | Указывает путь поиска файла, от которого зависит конвертируемый EDL-файл. |
| --use-prefix           | Опционально             | Добавляет префикс к имени прокси-функции. Префикс — это имя EDL-файла. |
| --header-only          | Опционально             | Определяет, что инструмент для создания кода генерирует только файлы заголовка. |
| --trusted-dir <path>   | Опционально             | Указывает каталог, в котором хранится сгенерированный вспомогательный код TEE. Если данный параметр не указан, по умолчанию используется текущий путь. |
| --untrusted-dir <path> | Опционально             | Указывает каталог, в котором находится вспомогательный код для генерирования небезопасных функций. |
| --trusted              | Опционально             | Генерирует вспомогательный код TEE.                          |
| --untrusted            | Опционально             | Генерирует вспомогательный код REE.                          |
| edlfile                | Обязательно             | EDL-файл, который необходимо конвертировать, например, hello.edl. |

#### Примеры

- Конвертируйте *helloworld.edl* для генерирования вспомогательного кода TEE в *enclave-directory* и вспомогательного кода REE в *host-directory*. Пример команды:

```shell
codegen_x86_64 --sgx --trusted-dir enclave-directory --untrusted-dir host-directory helloworld.edl
```

- Конвертируйте *helloworld.edl* для генерирования вспомогательного кода TEE в текущем каталоге. Ниже приведен пример команды, при выполнении которой не генерируется вспомогательный код REE.

```shell
codegen_x86_64 --sgx --trusted helloworld.edl
```

- Конвертируйте *helloworld.edl* для генерирования вспомогательного кода REE в текущем каталоге. Ниже приведен пример команды, при выполнении которой не генерируется вспомогательный код TEE.

```shell
codegen_x86_64 --sgx --untrusted  helloworld.edl
```

- Конвертируйте *helloworld.edl*. Ниже приведен пример команды для генерирования вспомогательного кода TEE и REE в текущем каталоге.

```shell
codegen_x86_64 --sgx helloworld.edl
```

## Инструмент подписи: sign\_tool

### Краткое описание

secGear sign\_tool — это инструмент командной строки, включающий в себя цепочку инструментов компиляции и инструмент подписи, которые используются для подписи enclave. sign\_tool имеет два режима подписи:

- Одноэтапная подпись: применяется только в режиме отладки.
- Двухэтапная подпись: применяется в случае коммерческого использования. Для подписи envlave необходимо получить закрытый ключ подписи от сторонней платформы или независимого устройства безопасности.

### Инструкции по использованию

#### **Формат**

Инструмент sign\_tool содержит команду sign (для подписи enclave) и команду digest (для генерации значения дайджеста). Формат команды:

**sign\_tool.sh -d** \[sign \| digest] **-x** <parameter>  **-i** <file>  **-p** <file>  **-s** <file>  \[OPTIONS] **–o** <file>

#### **Описание параметра**

| Параметр команды sign | Описание                                                     | Обязательно/Опционально                                      |
| --------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| -a <parameter>        | api\_level, который идентифицирует версию GP API iTrustee TA. Значение по умолчанию — 1. | Опционально                                                  |
| -c <file>             | Конфигурационный файл                                        | Опционально                                                  |
| -d <parameter>        | Указывает действие (sign или digest), которое должно быть выполнено инструментом подписи. | В одноэтапном режиме выполняется только операция sign. В двухэтапном режиме операция digest должна быть выполнена до операции sign. |
| -e <file>             | Сертификат открытого ключа устройства, который используется для защиты ключа AES для шифрования rawdata (обязательно для iTrustee). | Данный параметр является обязательным только для типа iTrustee. |
| -f <parameter>        | OTRP\_FLAG определяет, поддерживается ли стандартный протокол OTRP. Значение по умолчанию — 0. | Опционально                                                  |
| -i <file>             | Файл библиотеки, который необходимо подписать.               | Обязательно                                                  |
| -k <file>             | Закрытый ключ (PEM-файл), необходимый для одноэтапной подписи. | Данный параметр является обязательным только для типа SGX.   |
| -m <file>             | Конфигурационный файл безопасности mainfest.txt, который настроен пользователями. | Данный параметр является обязательным только для типа iTrustee. |
| -o <file>             | Выходной файл.                                               | Обязательно                                                  |
| -p <file>             | Сертификат открытого ключа (PEM-файл) сервера подписи, необходимый для двухэтапной подписи. | Обязательно                                                  |
| -s <file>             | Подписанное значение дайджеста, необходимое для двухэтапной подписи. | Обязательно                                                  |
| -t <parameter>        | TA\_TYPA, который идентифицирует двоичный формат TA iTrustee. Значение по умолчанию — 1. | Опционально                                                  |
| -x <parameter>        | Тип encalve (sgx или trustzone)                              | Обязательно                                                  |
| -h                    | Отображается справочная информация.                          | Опционально                                                  |

#### **Одноэтапная подпись**

Установите тип enclave на SGX, подпишите test.enclave и сгенерируйте файл подписи signed.enclave. Пример:

```shell
sign_tool.sh –d sign –x sgx –i test.enclave -k private_test.pem –o signed.enclave
```

#### **Двухэтапная подпись**

Ниже в качестве примера используется SGX для описания процедуры двухэтапной подписи.

1. Создайте значение дайджеста.
   
   Используйте инструмент sign\_tool для генерирования значения дайджеста digest.data и временного промежуточного файла signdata. Этот файл используется при создании файла подписи и автоматически удаляется после завершения подписи. Пример:
   
   ```shell
   sign_tool.sh –d digest –x sgx –i input –o digest.data
   ```

2. Отправьте digest.data в центр или платформу подписи и получите соответствующую подпись.

3. Используйте полученную подпись для генерирования подписанной динамической библиотеки signed.enclave.
   
   ```shell
   sign_tool.sh –d sign –x sgx–i input  –p pub.pem –s signature –o signed.enclave
   ```

Примечание. Чтобы выпустить официальную версию приложений, поддерживаемых Intel SGX, необходимо подать заявку на регистрацию в белом списке Intel. Подробную информацию о процедуре см. в документе Intel по адресу <https://software.intel.com/content/www/us/en/develop/download/overview-on-signing-and-whitelisting-for-intel-software-guard-extensions-enclaves.html>.